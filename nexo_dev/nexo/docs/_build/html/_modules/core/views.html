
<!DOCTYPE html>


<html lang="pt" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>core.views &#8212; Nexo - Documentação</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=2bde2ffa" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=68842761"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=30646c52"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script src="../../_static/translations.js?v=beaedd51"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/core/views';</script>
    <link rel="index" title="Índice" href="../../genindex.html" />
    <link rel="search" title="Pesquisar" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="pt"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content">Este é o sistema de documentação do Nexo - Sistema de Gestão Organizacional.</div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">Nexo - Documentação</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Pesquisar" aria-label="Pesquisar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Pesquisar</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Conteúdo Principal:</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">1. Visão Geral do Sistema Nexo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">2. Guia de Instalação</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">3. Início Rápido</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Referência API:</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../api/models.html">Modelos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/views.html">Views</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/seu-usuario/nexo" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Repositório fonte"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/seu-usuario/nexo/issues/new?title=Issue%20on%20page%20%2F_modules/core/views.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Abra um problema"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Modo tela cheia"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Pesquisar" aria-label="Pesquisar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Código fonte de core.views</h1><div class="highlight"><pre>
<span></span><span class="c1"># core/views.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">JsonResponse</span><span class="p">,</span> <span class="n">HttpResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.shortcuts</span><span class="w"> </span><span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">login</span><span class="p">,</span> <span class="n">authenticate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.views</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoginView</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.urls</span><span class="w"> </span><span class="kn">import</span> <span class="n">reverse_lazy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.decorators</span><span class="w"> </span><span class="kn">import</span> <span class="n">login_required</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.views.decorators.csrf</span><span class="w"> </span><span class="kn">import</span> <span class="n">csrf_protect</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">cache</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpResponseForbidden</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.forms</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">CustomLoginForm</span><span class="p">,</span>
    <span class="n">CustomRegisterForm</span><span class="p">,</span>
    <span class="n">DualFileUploadForm</span><span class="p">,</span>
    <span class="n">FileUploadForm</span><span class="p">,</span>
    <span class="n">UserUpdateForm</span><span class="p">,</span>
    <span class="n">PerfilUpdateForm</span><span class="p">,</span>
    <span class="n">CustomPasswordChangeForm</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">UnidadeCargo</span><span class="p">,</span> <span class="n">CargoSIORG</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">processa_planilhas</span><span class="p">,</span> <span class="n">processa_organograma</span><span class="p">,</span> <span class="n">estrutura_json_organograma</span><span class="p">,</span> <span class="n">processa_json_organograma</span><span class="p">,</span> <span class="n">gerar_anexo_simulacao</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib</span><span class="w"> </span><span class="kn">import</span> <span class="n">messages</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">allauth.account.views</span><span class="w"> </span><span class="kn">import</span> <span class="n">SignupView</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">allauth.socialaccount.views</span><span class="w"> </span><span class="kn">import</span> <span class="n">SignupView</span> <span class="k">as</span> <span class="n">SocialSignupView</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.template.loader</span><span class="w"> </span><span class="kn">import</span> <span class="n">render_to_string</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.html</span><span class="w"> </span><span class="kn">import</span> <span class="n">strip_tags</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.financeira_export</span><span class="w"> </span><span class="kn">import</span> <span class="n">dados_financeiros_backup</span><span class="p">,</span> <span class="n">exportar_csv_simples</span><span class="p">,</span> <span class="n">exportar_html_simples</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Perfil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">update_session_auth_hash</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.views.decorators.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">require_http_methods</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Q</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework.decorators</span><span class="w"> </span><span class="kn">import</span> <span class="n">api_view</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework.response</span><span class="w"> </span><span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework</span><span class="w"> </span><span class="kn">import</span> <span class="n">status</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.views.decorators.csrf</span><span class="w"> </span><span class="kn">import</span> <span class="n">csrf_exempt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.dados_json_update</span><span class="w"> </span><span class="kn">import</span> <span class="n">gerar_organograma_json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.paginator</span><span class="w"> </span><span class="kn">import</span> <span class="n">Paginator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.decorators</span><span class="w"> </span><span class="kn">import</span> <span class="n">method_decorator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.views</span><span class="w"> </span><span class="kn">import</span> <span class="n">View</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimulacaoSalva</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CustomLoginView</span><span class="p">(</span><span class="n">LoginView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;registration/login_direct.html&quot;</span>
    <span class="n">authentication_form</span> <span class="o">=</span> <span class="n">CustomLoginForm</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s2">&quot;home&quot;</span><span class="p">)</span>
    <span class="n">redirect_authenticated_user</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_success_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">next_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;next&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">next_url</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">next_url</span>
        <span class="k">return</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s2">&quot;home&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">form_invalid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="c1"># Implementar rate limiting apenas em produção</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">)</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;login_attempts_</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">attempts</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">attempts</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;Muitas tentativas de login. Tente novamente em 15 minutos.&quot;</span><span class="p">)</span>
            
            <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">attempts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">900</span><span class="p">)</span>  <span class="c1"># 15 minutos</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_invalid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_success_url</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_invalid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>


<span class="nd">@csrf_protect</span>
<span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># Redirecionar para a página de login com mensagem informativa</span>
    <span class="n">messages</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;O cadastro de usuários só pode ser feito pelo administrador do sistema.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">)</span>


<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s2">&quot;/login_direct/&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;home.html&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span>


<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">organograma</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Renderiza a página do organograma.&quot;&quot;&quot;</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">estrutura_json_organograma</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">UnidadeCargo</span><span class="p">,</span> <span class="n">CargoSIORG</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
        
        <span class="c1"># Buscar dados diretamente do banco de dados</span>
        <span class="n">dados</span> <span class="o">=</span> <span class="n">estrutura_json_organograma</span><span class="p">()</span>
        
        <span class="c1"># Converter para string JSON para passar ao template</span>
        <span class="n">organograma_data_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
            <span class="s1">&#39;core_unidadecargo&#39;</span><span class="p">:</span> <span class="n">dados</span><span class="p">,</span>
            <span class="s1">&#39;core_cargosiorg&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;cargo&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cargo</span><span class="o">.</span><span class="n">cargo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s1">&#39;valor&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">cargo</span><span class="o">.</span><span class="n">valor</span><span class="p">),</span>
                    <span class="s1">&#39;unitario&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">cargo</span><span class="o">.</span><span class="n">unitario</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">cargo</span> <span class="ow">in</span> <span class="n">CargoSIORG</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="p">]</span>
        <span class="p">})</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Log do erro e usar dados mínimos como fallback</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao carregar dados do organograma: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">organograma_data_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
            <span class="s2">&quot;core_unidadecargo&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;tipo_unidade&quot;</span><span class="p">:</span> <span class="s2">&quot;Órgão&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;denominacao_unidade&quot;</span><span class="p">:</span> <span class="s2">&quot;Ministério do Planejamento e Orçamento - MPO&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;codigo_unidade&quot;</span><span class="p">:</span> <span class="s2">&quot;308804&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;sigla&quot;</span><span class="p">:</span> <span class="s2">&quot;MPO&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;tipo_cargo&quot;</span><span class="p">:</span> <span class="s2">&quot;MEST&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;denominacao&quot;</span><span class="p">:</span> <span class="s2">&quot;Ministro de Estado&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;categoria&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;nivel&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;quantidade&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;grafo&quot;</span><span class="p">:</span> <span class="s2">&quot;308804&quot;</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;core_cargosiorg&quot;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">})</span>
    
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;core/organograma.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;organograma_data&#39;</span><span class="p">:</span> <span class="n">organograma_data_json</span>
    <span class="p">})</span>
    

<div class="viewcode-block" id="organograma_view">
<a class="viewcode-back" href="../../api/views.html#core.views.organograma_view">[documentos]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">organograma_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;core/organograma.html&#39;</span><span class="p">)</span></div>



<span class="nd">@require_http_methods</span><span class="p">([</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">organograma_redirect</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;View para redirecionar da URL original do organograma para a nova visualização&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;organograma_redirect.html&#39;</span><span class="p">)</span>


<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">organograma_data</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Endpoint que retorna os dados do organograma em formato JSON.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">processa_organograma</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">UnidadeCargo</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Buscar dados do organograma</span>
        <span class="n">organograma</span> <span class="o">=</span> <span class="n">processa_organograma</span><span class="p">()</span>
        
        <span class="c1"># Contar total de unidades</span>
        <span class="n">total_unidades</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">organograma</span><span class="p">)</span>
        
        <span class="c1"># Contar unidades com valores</span>
        <span class="n">unidades_com_valores</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">organograma</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;custo_total&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Preparar mensagem sobre os dados filtrados</span>
        <span class="n">mensagem</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">total_unidades</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">total_registros</span> <span class="o">=</span> <span class="n">UnidadeCargo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="n">registros_filtrados</span> <span class="o">=</span> <span class="n">total_registros</span> <span class="o">-</span> <span class="n">UnidadeCargo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">grafo__exact</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">grafo__isnull</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">registros_filtrados</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mensagem</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">registros_filtrados</span><span class="si">}</span><span class="s2"> registros foram filtrados por não pertencerem à estrutura do ministério.&quot;</span>
        
        <span class="c1"># Retornar os dados em formato JSON</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">organograma</span><span class="p">,</span>
            <span class="s1">&#39;meta&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;total_unidades&#39;</span><span class="p">:</span> <span class="n">total_unidades</span><span class="p">,</span>
                <span class="s1">&#39;unidades_com_valores&#39;</span><span class="p">:</span> <span class="n">unidades_com_valores</span><span class="p">,</span>
                <span class="s1">&#39;mensagem&#39;</span><span class="p">:</span> <span class="n">mensagem</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Log do erro para depuração</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao processar dados do organograma: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Retornar mensagem de erro</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Ocorreu um erro ao processar os dados: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>


<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">organograma_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Renderiza a página do organograma.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;core/organograma.html&#39;</span><span class="p">)</span>


<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s2">&quot;/login_direct/&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">simulacao_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    View que renderiza a página de simulação do organograma</span>
<span class="sd">    onde o usuário pode adicionar nomes e criar conexões manualmente.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">JsonResponse</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Tentar ler o arquivo organograma.json para passar ao template</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
        
        <span class="n">json_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;core&#39;</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;organograma.json&#39;</span><span class="p">)</span>
        
        <span class="c1"># Verificar se o arquivo existe</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">json_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">organograma_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                
            <span class="c1"># Converter para string JSON para passar ao template</span>
            <span class="n">organograma_data_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">organograma_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Se o arquivo não existir, usar um objeto vazio</span>
            <span class="n">organograma_data_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
                <span class="s2">&quot;core_unidadecargo&quot;</span><span class="p">:</span> <span class="p">[]</span>
            <span class="p">})</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Em caso de erro, usar um objeto vazio</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao carregar dados do organograma para simulacao_page: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">organograma_data_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
            <span class="s2">&quot;core_unidadecargo&quot;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">})</span>
    
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;core/simulacao.html&quot;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;organograma_data&#39;</span><span class="p">:</span> <span class="n">organograma_data_json</span>
    <span class="p">})</span>


<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s2">&quot;/login_direct/&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">financeira_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    View que renderiza a página financeira com integração</span>
<span class="sd">    direta com o organograma e simulação.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;core/financeira.html&quot;</span><span class="p">)</span>


<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s2">&quot;/login_direct/&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">financeira_data</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retorna dados financeiros em formato JSON reutilizando a mesma</span>
<span class="sd">    lógica empregada pela API de Organograma. Toda a computação é</span>
<span class="sd">    delegada à função `financeira_data_real`, garantindo consistência</span>
<span class="sd">    e eliminando a antiga API simulada.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Delega imediatamente para a implementação baseada no organograma.</span>
    <span class="k">return</span> <span class="n">financeira_data_real</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>


<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s2">&quot;/login_direct/&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">financeira_export</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exporta dados financeiros em diferentes formatos: PDF, CSV, XLSX, HTML</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Processar parâmetros do request</span>
        <span class="n">formato</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;formato&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">)</span>
        <span class="n">periodo</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;periodo&#39;</span><span class="p">,</span> <span class="s1">&#39;Mês Atual&#39;</span><span class="p">)</span>
        <span class="n">componente</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;componente&#39;</span><span class="p">,</span> <span class="s1">&#39;completo&#39;</span><span class="p">)</span>
        
        <span class="c1"># Obter dados financeiros</span>
        <span class="c1"># Reutilização da lógica de financeira_data</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">financeira_data</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">dados</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="n">dados</span><span class="p">[</span><span class="s2">&quot;titulo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Relatório de Pontuação&quot;</span>
                <span class="n">dados</span><span class="p">[</span><span class="s2">&quot;periodo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">periodo</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Usar dados de backup</span>
                <span class="n">dados</span> <span class="o">=</span> <span class="n">dados_financeiros_backup</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Em caso de erro, usar dados de backup</span>
            <span class="n">dados</span> <span class="o">=</span> <span class="n">dados_financeiros_backup</span><span class="p">()</span>
            
        <span class="c1"># Filtrar dados conforme o componente solicitado</span>
        <span class="k">if</span> <span class="n">componente</span> <span class="o">==</span> <span class="s1">&#39;resumo&#39;</span><span class="p">:</span>
            <span class="n">dados_filtrados</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;orcamento_total&quot;</span><span class="p">:</span> <span class="n">dados</span><span class="p">[</span><span class="s2">&quot;orcamento_total&quot;</span><span class="p">],</span>
                <span class="s2">&quot;executado_total&quot;</span><span class="p">:</span> <span class="n">dados</span><span class="p">[</span><span class="s2">&quot;executado_total&quot;</span><span class="p">],</span>
                <span class="s2">&quot;variacao_periodo&quot;</span><span class="p">:</span> <span class="n">dados</span><span class="p">[</span><span class="s2">&quot;variacao_periodo&quot;</span><span class="p">],</span>
                <span class="s2">&quot;titulo&quot;</span><span class="p">:</span> <span class="s2">&quot;Resumo de Pontuação&quot;</span><span class="p">,</span>
                <span class="s2">&quot;periodo&quot;</span><span class="p">:</span> <span class="n">periodo</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">componente</span> <span class="o">==</span> <span class="s1">&#39;distribuicao&#39;</span><span class="p">:</span>
            <span class="n">dados_filtrados</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;unidades&quot;</span><span class="p">:</span> <span class="n">dados</span><span class="p">[</span><span class="s2">&quot;unidades&quot;</span><span class="p">],</span>
                <span class="s2">&quot;titulo&quot;</span><span class="p">:</span> <span class="s2">&quot;Distribuição por Unidade&quot;</span><span class="p">,</span>
                <span class="s2">&quot;periodo&quot;</span><span class="p">:</span> <span class="n">periodo</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">componente</span> <span class="o">==</span> <span class="s1">&#39;execucao&#39;</span><span class="p">:</span>
            <span class="n">dados_filtrados</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;execucao_mensal&quot;</span><span class="p">:</span> <span class="n">dados</span><span class="p">[</span><span class="s2">&quot;execucao_mensal&quot;</span><span class="p">],</span>
                <span class="s2">&quot;titulo&quot;</span><span class="p">:</span> <span class="s2">&quot;Execução Orçamentária&quot;</span><span class="p">,</span>
                <span class="s2">&quot;periodo&quot;</span><span class="p">:</span> <span class="n">periodo</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># completo</span>
            <span class="n">dados_filtrados</span> <span class="o">=</span> <span class="n">dados</span>
            
        <span class="c1"># Exportar conforme o formato</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">formato</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">exportar_csv</span><span class="p">(</span><span class="n">dados_filtrados</span><span class="p">,</span> <span class="n">componente</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">formato</span> <span class="o">==</span> <span class="s1">&#39;xlsx&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">exportar_xlsx</span><span class="p">(</span><span class="n">dados_filtrados</span><span class="p">,</span> <span class="n">componente</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">formato</span> <span class="o">==</span> <span class="s1">&#39;pdf&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">exportar_pdf</span><span class="p">(</span><span class="n">dados_filtrados</span><span class="p">,</span> <span class="n">componente</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># html</span>
                <span class="k">return</span> <span class="n">exportar_html</span><span class="p">(</span><span class="n">dados_filtrados</span><span class="p">,</span> <span class="n">componente</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Em caso de falha na exportação, usar versões simplificadas de backup</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao exportar dados no formato </span><span class="si">{</span><span class="n">formato</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">formato</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">exportar_csv_simples</span><span class="p">(</span><span class="n">dados_filtrados</span><span class="p">,</span> <span class="n">componente</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">formato</span> <span class="o">==</span> <span class="s1">&#39;xlsx&#39;</span><span class="p">:</span>
                <span class="c1"># Para XLSX, retornar CSV como fallback</span>
                <span class="k">return</span> <span class="n">exportar_csv_simples</span><span class="p">(</span><span class="n">dados_filtrados</span><span class="p">,</span> <span class="n">componente</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">formato</span> <span class="o">==</span> <span class="s1">&#39;pdf&#39;</span><span class="p">:</span>
                <span class="c1"># Para PDF, retornar HTML como fallback</span>
                <span class="k">return</span> <span class="n">exportar_html_simples</span><span class="p">(</span><span class="n">dados_filtrados</span><span class="p">,</span> <span class="n">componente</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">exportar_html_simples</span><span class="p">(</span><span class="n">dados_filtrados</span><span class="p">,</span> <span class="n">componente</span><span class="p">)</span>
            
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao exportar dados financeiros: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Retornar página de erro como último recurso</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            &lt;html&gt;</span>
<span class="s2">            &lt;head&gt;&lt;title&gt;Erro de Exportação&lt;/title&gt;&lt;/head&gt;</span>
<span class="s2">            &lt;body&gt;</span>
<span class="s2">                &lt;h1&gt;Erro ao exportar dados&lt;/h1&gt;</span>
<span class="s2">                &lt;p&gt;Ocorreu um erro ao processar sua solicitação. Por favor, tente novamente mais tarde.&lt;/p&gt;</span>
<span class="s2">                &lt;p&gt;Detalhe: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/p&gt;</span>
<span class="s2">                &lt;a href=&quot;javascript:history.back()&quot;&gt;Voltar&lt;/a&gt;</span>
<span class="s2">            &lt;/body&gt;</span>
<span class="s2">            &lt;/html&gt;</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/html&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>


<span class="k">def</span><span class="w"> </span><span class="nf">exportar_csv</span><span class="p">(</span><span class="n">dados</span><span class="p">,</span> <span class="n">componente</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exportar dados para CSV&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/csv&#39;</span><span class="p">)</span>
    <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;attachment; filename=&quot;financeiro_</span><span class="si">{</span><span class="n">componente</span><span class="si">}</span><span class="s1">.csv&quot;&#39;</span>
    
    <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">componente</span> <span class="o">==</span> <span class="s1">&#39;resumo&#39;</span><span class="p">:</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;Métrica&#39;</span><span class="p">,</span> <span class="s1">&#39;Valor&#39;</span><span class="p">])</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;Orçamento Total&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;R$ </span><span class="si">{</span><span class="n">dados</span><span class="p">[</span><span class="s2">&quot;orcamento_total&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;Executado Total&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;R$ </span><span class="si">{</span><span class="n">dados</span><span class="p">[</span><span class="s2">&quot;executado_total&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;Variação Período&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dados</span><span class="p">[</span><span class="s2">&quot;variacao_periodo&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">componente</span> <span class="o">==</span> <span class="s1">&#39;distribuicao&#39;</span><span class="p">:</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;Unidade&#39;</span><span class="p">,</span> <span class="s1">&#39;Orçamento&#39;</span><span class="p">,</span> <span class="s1">&#39;Executado&#39;</span><span class="p">,</span> <span class="s1">&#39;Percentual&#39;</span><span class="p">,</span> <span class="s1">&#39;Status&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">unidade</span> <span class="ow">in</span> <span class="n">dados</span><span class="p">[</span><span class="s2">&quot;unidades&quot;</span><span class="p">]:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span>
                <span class="n">unidade</span><span class="p">[</span><span class="s2">&quot;nome&quot;</span><span class="p">],</span>
                <span class="sa">f</span><span class="s1">&#39;R$ </span><span class="si">{</span><span class="n">unidade</span><span class="p">[</span><span class="s2">&quot;orcamento&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;R$ </span><span class="si">{</span><span class="n">unidade</span><span class="p">[</span><span class="s2">&quot;executado&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">unidade</span><span class="p">[</span><span class="s2">&quot;percentual&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">,</span>
                <span class="n">unidade</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span>
            <span class="p">])</span>
    <span class="k">elif</span> <span class="n">componente</span> <span class="o">==</span> <span class="s1">&#39;execucao&#39;</span><span class="p">:</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;Mês&#39;</span><span class="p">,</span> <span class="s1">&#39;Orçado&#39;</span><span class="p">,</span> <span class="s1">&#39;Executado&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">execucao</span> <span class="ow">in</span> <span class="n">dados</span><span class="p">[</span><span class="s2">&quot;execucao_mensal&quot;</span><span class="p">]:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span>
                <span class="n">execucao</span><span class="p">[</span><span class="s2">&quot;mes&quot;</span><span class="p">],</span>
                <span class="sa">f</span><span class="s1">&#39;R$ </span><span class="si">{</span><span class="n">execucao</span><span class="p">[</span><span class="s2">&quot;orcado&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;R$ </span><span class="si">{</span><span class="n">execucao</span><span class="p">[</span><span class="s2">&quot;executado&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># completo</span>
        <span class="c1"># Sumário</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;RELATÓRIO FINANCEIRO COMPLETO&#39;</span><span class="p">])</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;Período&#39;</span><span class="p">,</span> <span class="n">dados</span><span class="p">[</span><span class="s2">&quot;periodo&quot;</span><span class="p">]])</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;Data Geração&#39;</span><span class="p">,</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">)])</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([])</span>
        
        <span class="c1"># Resumo</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;RESUMO FINANCEIRO&#39;</span><span class="p">])</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;Orçamento Total&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;R$ </span><span class="si">{</span><span class="n">dados</span><span class="p">[</span><span class="s2">&quot;orcamento_total&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;Executado Total&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;R$ </span><span class="si">{</span><span class="n">dados</span><span class="p">[</span><span class="s2">&quot;executado_total&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;Variação Período&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dados</span><span class="p">[</span><span class="s2">&quot;variacao_periodo&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">])</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([])</span>
        
        <span class="c1"># Distribuição</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;DISTRIBUIÇÃO POR UNIDADE&#39;</span><span class="p">])</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;Unidade&#39;</span><span class="p">,</span> <span class="s1">&#39;Orçamento&#39;</span><span class="p">,</span> <span class="s1">&#39;Executado&#39;</span><span class="p">,</span> <span class="s1">&#39;Percentual&#39;</span><span class="p">,</span> <span class="s1">&#39;Status&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">unidade</span> <span class="ow">in</span> <span class="n">dados</span><span class="p">[</span><span class="s2">&quot;unidades&quot;</span><span class="p">]:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span>
                <span class="n">unidade</span><span class="p">[</span><span class="s2">&quot;nome&quot;</span><span class="p">],</span>
                <span class="sa">f</span><span class="s1">&#39;R$ </span><span class="si">{</span><span class="n">unidade</span><span class="p">[</span><span class="s2">&quot;orcamento&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;R$ </span><span class="si">{</span><span class="n">unidade</span><span class="p">[</span><span class="s2">&quot;executado&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">unidade</span><span class="p">[</span><span class="s2">&quot;percentual&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">,</span>
                <span class="n">unidade</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span>
            <span class="p">])</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([])</span>
        
        <span class="c1"># Execução</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;EXECUÇÃO ORÇAMENTÁRIA&#39;</span><span class="p">])</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;Mês&#39;</span><span class="p">,</span> <span class="s1">&#39;Orçado&#39;</span><span class="p">,</span> <span class="s1">&#39;Executado&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">execucao</span> <span class="ow">in</span> <span class="n">dados</span><span class="p">[</span><span class="s2">&quot;execucao_mensal&quot;</span><span class="p">]:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span>
                <span class="n">execucao</span><span class="p">[</span><span class="s2">&quot;mes&quot;</span><span class="p">],</span>
                <span class="sa">f</span><span class="s1">&#39;R$ </span><span class="si">{</span><span class="n">execucao</span><span class="p">[</span><span class="s2">&quot;orcado&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;R$ </span><span class="si">{</span><span class="n">execucao</span><span class="p">[</span><span class="s2">&quot;executado&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">])</span>
            
    <span class="k">return</span> <span class="n">response</span>


<span class="k">def</span><span class="w"> </span><span class="nf">exportar_xlsx</span><span class="p">(</span><span class="n">dados</span><span class="p">,</span> <span class="n">componente</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exportar dados para XLSX&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">xlsxwriter</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="c1"># Fallback para CSV se xlsxwriter não estiver disponível</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/plain&#39;</span><span class="p">)</span>
        <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;attachment; filename=&quot;erro.txt&quot;&#39;</span>
        <span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Biblioteca xlsxwriter não está instalada. Tente exportar como CSV.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
    
    <span class="c1"># Criar arquivo temporário</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">workbook</span> <span class="o">=</span> <span class="n">xlsxwriter</span><span class="o">.</span><span class="n">Workbook</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        
        <span class="c1"># Formatos</span>
        <span class="n">titulo_format</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span>
            <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> 
            <span class="s1">&#39;font_size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> 
            <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span>
        <span class="p">})</span>
        <span class="n">header_format</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span>
            <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> 
            <span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#D0D0D0&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;border&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">})</span>
        <span class="n">cell_format</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;border&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">money_format</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span>
            <span class="s1">&#39;num_format&#39;</span><span class="p">:</span> <span class="s1">&#39;R$ #,##0.00&#39;</span><span class="p">,</span>
            <span class="s1">&#39;border&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">})</span>
        <span class="n">percent_format</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span>
            <span class="s1">&#39;num_format&#39;</span><span class="p">:</span> <span class="s1">&#39;0.0%&#39;</span><span class="p">,</span>
            <span class="s1">&#39;border&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">})</span>
        
        <span class="c1"># Criar planilha baseada no componente</span>
        <span class="k">if</span> <span class="n">componente</span> <span class="o">==</span> <span class="s1">&#39;resumo&#39;</span><span class="p">:</span>
            <span class="n">worksheet</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="s1">&#39;Resumo Financeiro&#39;</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;A:A&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;B:B&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
            
            <span class="c1"># Título</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">merge_range</span><span class="p">(</span><span class="s1">&#39;A1:B1&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Resumo Financeiro - </span><span class="si">{</span><span class="n">dados</span><span class="p">[</span><span class="s2">&quot;periodo&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">titulo_format</span><span class="p">)</span>
            
            <span class="c1"># Cabeçalhos</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;A3&#39;</span><span class="p">,</span> <span class="s1">&#39;Métrica&#39;</span><span class="p">,</span> <span class="n">header_format</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;B3&#39;</span><span class="p">,</span> <span class="s1">&#39;Valor&#39;</span><span class="p">,</span> <span class="n">header_format</span><span class="p">)</span>
            
            <span class="c1"># Dados</span>
            <span class="n">row</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Orçamento Total&#39;</span><span class="p">,</span> <span class="n">cell_format</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">dados</span><span class="p">[</span><span class="s2">&quot;orcamento_total&quot;</span><span class="p">]),</span> <span class="n">money_format</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Executado Total&#39;</span><span class="p">,</span> <span class="n">cell_format</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">dados</span><span class="p">[</span><span class="s2">&quot;executado_total&quot;</span><span class="p">]),</span> <span class="n">money_format</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Variação Período&#39;</span><span class="p">,</span> <span class="n">cell_format</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">dados</span><span class="p">[</span><span class="s2">&quot;variacao_periodo&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="n">percent_format</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="n">componente</span> <span class="o">==</span> <span class="s1">&#39;distribuicao&#39;</span><span class="p">:</span>
            <span class="n">worksheet</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="s1">&#39;Distribuição por Unidade&#39;</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;A:A&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;B:D&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;E:E&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
            
            <span class="c1"># Título</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">merge_range</span><span class="p">(</span><span class="s1">&#39;A1:E1&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Distribuição por Unidade - </span><span class="si">{</span><span class="n">dados</span><span class="p">[</span><span class="s2">&quot;periodo&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">titulo_format</span><span class="p">)</span>
            
            <span class="c1"># Cabeçalhos</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;A3&#39;</span><span class="p">,</span> <span class="s1">&#39;Unidade&#39;</span><span class="p">,</span> <span class="n">header_format</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;B3&#39;</span><span class="p">,</span> <span class="s1">&#39;Orçamento&#39;</span><span class="p">,</span> <span class="n">header_format</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;C3&#39;</span><span class="p">,</span> <span class="s1">&#39;Executado&#39;</span><span class="p">,</span> <span class="n">header_format</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;D3&#39;</span><span class="p">,</span> <span class="s1">&#39;Percentual&#39;</span><span class="p">,</span> <span class="n">header_format</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;E3&#39;</span><span class="p">,</span> <span class="s1">&#39;Status&#39;</span><span class="p">,</span> <span class="n">header_format</span><span class="p">)</span>
            
            <span class="c1"># Dados</span>
            <span class="n">row</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="k">for</span> <span class="n">unidade</span> <span class="ow">in</span> <span class="n">dados</span><span class="p">[</span><span class="s2">&quot;unidades&quot;</span><span class="p">]:</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">unidade</span><span class="p">[</span><span class="s2">&quot;nome&quot;</span><span class="p">],</span> <span class="n">cell_format</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">unidade</span><span class="p">[</span><span class="s2">&quot;orcamento&quot;</span><span class="p">]),</span> <span class="n">money_format</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">unidade</span><span class="p">[</span><span class="s2">&quot;executado&quot;</span><span class="p">]),</span> <span class="n">money_format</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">unidade</span><span class="p">[</span><span class="s2">&quot;percentual&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="n">percent_format</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">unidade</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">],</span> <span class="n">cell_format</span><span class="p">)</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
                
        <span class="k">elif</span> <span class="n">componente</span> <span class="o">==</span> <span class="s1">&#39;execucao&#39;</span><span class="p">:</span>
            <span class="n">worksheet</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="s1">&#39;Execução Orçamentária&#39;</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;A:A&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;B:C&#39;</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span>
            
            <span class="c1"># Título</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">merge_range</span><span class="p">(</span><span class="s1">&#39;A1:C1&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Execução Orçamentária - </span><span class="si">{</span><span class="n">dados</span><span class="p">[</span><span class="s2">&quot;periodo&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">titulo_format</span><span class="p">)</span>
            
            <span class="c1"># Cabeçalhos</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;A3&#39;</span><span class="p">,</span> <span class="s1">&#39;Mês&#39;</span><span class="p">,</span> <span class="n">header_format</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;B3&#39;</span><span class="p">,</span> <span class="s1">&#39;Orçado&#39;</span><span class="p">,</span> <span class="n">header_format</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;C3&#39;</span><span class="p">,</span> <span class="s1">&#39;Executado&#39;</span><span class="p">,</span> <span class="n">header_format</span><span class="p">)</span>
            
            <span class="c1"># Dados</span>
            <span class="n">row</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="k">for</span> <span class="n">execucao</span> <span class="ow">in</span> <span class="n">dados</span><span class="p">[</span><span class="s2">&quot;execucao_mensal&quot;</span><span class="p">]:</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">execucao</span><span class="p">[</span><span class="s2">&quot;mes&quot;</span><span class="p">],</span> <span class="n">cell_format</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">execucao</span><span class="p">[</span><span class="s2">&quot;orcado&quot;</span><span class="p">]),</span> <span class="n">money_format</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">execucao</span><span class="p">[</span><span class="s2">&quot;executado&quot;</span><span class="p">]),</span> <span class="n">money_format</span><span class="p">)</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
                
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># completo</span>
            <span class="c1"># Planilha de Resumo</span>
            <span class="n">worksheet</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="s1">&#39;Resumo&#39;</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;A:A&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;B:B&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
            
            <span class="c1"># Título e informações</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">merge_range</span><span class="p">(</span><span class="s1">&#39;A1:B1&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Relatório Financeiro - </span><span class="si">{</span><span class="n">dados</span><span class="p">[</span><span class="s2">&quot;periodo&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">titulo_format</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;A2&#39;</span><span class="p">,</span> <span class="s1">&#39;Data Geração:&#39;</span><span class="p">,</span> <span class="n">cell_format</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;B2&#39;</span><span class="p">,</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">),</span> <span class="n">cell_format</span><span class="p">)</span>
            
            <span class="c1"># Resumo</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;A4&#39;</span><span class="p">,</span> <span class="s1">&#39;Métrica&#39;</span><span class="p">,</span> <span class="n">header_format</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;B4&#39;</span><span class="p">,</span> <span class="s1">&#39;Valor&#39;</span><span class="p">,</span> <span class="n">header_format</span><span class="p">)</span>
            
            <span class="n">row</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Orçamento Total&#39;</span><span class="p">,</span> <span class="n">cell_format</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">dados</span><span class="p">[</span><span class="s2">&quot;orcamento_total&quot;</span><span class="p">]),</span> <span class="n">money_format</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Executado Total&#39;</span><span class="p">,</span> <span class="n">cell_format</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">dados</span><span class="p">[</span><span class="s2">&quot;executado_total&quot;</span><span class="p">]),</span> <span class="n">money_format</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Variação Período&#39;</span><span class="p">,</span> <span class="n">cell_format</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">dados</span><span class="p">[</span><span class="s2">&quot;variacao_periodo&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="n">percent_format</span><span class="p">)</span>
            
            <span class="c1"># Planilha de Distribuição</span>
            <span class="n">worksheet</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="s1">&#39;Distribuição&#39;</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;A:A&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;B:D&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;E:E&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
            
            <span class="c1"># Título</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">merge_range</span><span class="p">(</span><span class="s1">&#39;A1:E1&#39;</span><span class="p">,</span> <span class="s1">&#39;Distribuição por Unidade&#39;</span><span class="p">,</span> <span class="n">titulo_format</span><span class="p">)</span>
            
            <span class="c1"># Cabeçalhos</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;A3&#39;</span><span class="p">,</span> <span class="s1">&#39;Unidade&#39;</span><span class="p">,</span> <span class="n">header_format</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;B3&#39;</span><span class="p">,</span> <span class="s1">&#39;Orçamento&#39;</span><span class="p">,</span> <span class="n">header_format</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;C3&#39;</span><span class="p">,</span> <span class="s1">&#39;Executado&#39;</span><span class="p">,</span> <span class="n">header_format</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;D3&#39;</span><span class="p">,</span> <span class="s1">&#39;Percentual&#39;</span><span class="p">,</span> <span class="n">header_format</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;E3&#39;</span><span class="p">,</span> <span class="s1">&#39;Status&#39;</span><span class="p">,</span> <span class="n">header_format</span><span class="p">)</span>
            
            <span class="c1"># Dados</span>
            <span class="n">row</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="k">for</span> <span class="n">unidade</span> <span class="ow">in</span> <span class="n">dados</span><span class="p">[</span><span class="s2">&quot;unidades&quot;</span><span class="p">]:</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">unidade</span><span class="p">[</span><span class="s2">&quot;nome&quot;</span><span class="p">],</span> <span class="n">cell_format</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">unidade</span><span class="p">[</span><span class="s2">&quot;orcamento&quot;</span><span class="p">]),</span> <span class="n">money_format</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">unidade</span><span class="p">[</span><span class="s2">&quot;executado&quot;</span><span class="p">]),</span> <span class="n">money_format</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">unidade</span><span class="p">[</span><span class="s2">&quot;percentual&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="n">percent_format</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">unidade</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">],</span> <span class="n">cell_format</span><span class="p">)</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
                
            <span class="c1"># Planilha de Execução</span>
            <span class="n">worksheet</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="s1">&#39;Execução&#39;</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;A:A&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;B:C&#39;</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span>
            
            <span class="c1"># Título</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">merge_range</span><span class="p">(</span><span class="s1">&#39;A1:C1&#39;</span><span class="p">,</span> <span class="s1">&#39;Execução Orçamentária&#39;</span><span class="p">,</span> <span class="n">titulo_format</span><span class="p">)</span>
            
            <span class="c1"># Cabeçalhos</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;A3&#39;</span><span class="p">,</span> <span class="s1">&#39;Mês&#39;</span><span class="p">,</span> <span class="n">header_format</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;B3&#39;</span><span class="p">,</span> <span class="s1">&#39;Orçado&#39;</span><span class="p">,</span> <span class="n">header_format</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;C3&#39;</span><span class="p">,</span> <span class="s1">&#39;Executado&#39;</span><span class="p">,</span> <span class="n">header_format</span><span class="p">)</span>
            
            <span class="c1"># Dados</span>
            <span class="n">row</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="k">for</span> <span class="n">execucao</span> <span class="ow">in</span> <span class="n">dados</span><span class="p">[</span><span class="s2">&quot;execucao_mensal&quot;</span><span class="p">]:</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">execucao</span><span class="p">[</span><span class="s2">&quot;mes&quot;</span><span class="p">],</span> <span class="n">cell_format</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">execucao</span><span class="p">[</span><span class="s2">&quot;orcado&quot;</span><span class="p">]),</span> <span class="n">money_format</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">execucao</span><span class="p">[</span><span class="s2">&quot;executado&quot;</span><span class="p">]),</span> <span class="n">money_format</span><span class="p">)</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Fechar o workbook</span>
        <span class="n">workbook</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="c1"># Preparar a resposta</span>
        <span class="n">output</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#39;</span><span class="p">)</span>
        <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;attachment; filename=&quot;financeiro_</span><span class="si">{</span><span class="n">componente</span><span class="si">}</span><span class="s1">.xlsx&quot;&#39;</span>
        
        <span class="k">return</span> <span class="n">response</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao criar arquivo Excel: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Retornar mensagem de erro se algo falhar</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/plain&#39;</span><span class="p">)</span>
        <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;attachment; filename=&quot;erro.txt&quot;&#39;</span>
        <span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Erro ao gerar arquivo Excel: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>


<span class="k">def</span><span class="w"> </span><span class="nf">exportar_pdf</span><span class="p">(</span><span class="n">dados</span><span class="p">,</span> <span class="n">componente</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exportar dados para PDF&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Se weasyprint estiver instalado, usamos para conversão HTML -&gt; PDF</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">weasyprint</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTML</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Primeiro geramos o HTML</span>
            <span class="n">html_content</span> <span class="o">=</span> <span class="n">exportar_html</span><span class="p">(</span><span class="n">dados</span><span class="p">,</span> <span class="n">componente</span><span class="p">,</span> <span class="n">para_pdf</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            
            <span class="c1"># Converter HTML para PDF</span>
            <span class="n">pdf_bytes</span> <span class="o">=</span> <span class="n">HTML</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="n">html_content</span><span class="p">)</span><span class="o">.</span><span class="n">write_pdf</span><span class="p">()</span>
            
            <span class="c1"># Retornar como resposta</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">pdf_bytes</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/pdf&#39;</span><span class="p">)</span>
            <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;attachment; filename=&quot;financeiro_</span><span class="si">{</span><span class="n">componente</span><span class="si">}</span><span class="s1">.pdf&quot;&#39;</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao gerar PDF: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Retornar mensagem de erro se algo falhar no processamento</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/plain&#39;</span><span class="p">)</span>
            <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;attachment; filename=&quot;erro_pdf.txt&quot;&#39;</span>
            <span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Erro ao gerar PDF: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">. Tente exportar como HTML ou CSV.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="c1"># Fallback: explicar que weasyprint não está instalado</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/plain&#39;</span><span class="p">)</span>
        <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;attachment; filename=&quot;erro.txt&quot;&#39;</span>
        <span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Biblioteca weasyprint não está instalada. Tente exportar como HTML ou CSV.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>


<span class="k">def</span><span class="w"> </span><span class="nf">exportar_html</span><span class="p">(</span><span class="n">dados</span><span class="p">,</span> <span class="n">componente</span><span class="p">,</span> <span class="n">para_pdf</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exportar dados para HTML&quot;&quot;&quot;</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;dados&#39;</span><span class="p">:</span> <span class="n">dados</span><span class="p">,</span>
        <span class="s1">&#39;componente&#39;</span><span class="p">:</span> <span class="n">componente</span><span class="p">,</span>
        <span class="s1">&#39;data_geracao&#39;</span><span class="p">:</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
        <span class="s1">&#39;para_pdf&#39;</span><span class="p">:</span> <span class="n">para_pdf</span>
    <span class="p">}</span>
    
    <span class="c1"># Renderizar o template HTML</span>
    <span class="n">html_string</span> <span class="o">=</span> <span class="n">render_to_string</span><span class="p">(</span><span class="s1">&#39;core/exports/financeira_export.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">html_string</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/html&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">para_pdf</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;inline; filename=&quot;financeiro_</span><span class="si">{</span><span class="n">componente</span><span class="si">}</span><span class="s1">.html&quot;&#39;</span>
    
    <span class="k">return</span> <span class="n">response</span>


<span class="c1"># Social login handling</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CustomSocialLoginView</span><span class="p">(</span><span class="n">SocialSignupView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle social login success or failure</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_success_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s2">&quot;home&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">form_invalid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
            <span class="s2">&quot;Falha na autenticação social. Por favor, tente novamente ou use outro método.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_invalid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="c1"># Additional logic for successful login can be added here</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>

    <span class="c1"># Sobrescrevendo para evitar loops de redirecionamento</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Se o usuário já estiver autenticado, redirecione para a página inicial</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_success_url</span><span class="p">())</span>

        <span class="c1"># Processa os dados de sociallogin na sessão para criar um usuário</span>
        <span class="n">sociallogin</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;socialaccount_sociallogin&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sociallogin</span><span class="p">:</span>
            <span class="c1"># Automaticamente cria o usuário e faz login</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">sociallogin</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span>
            <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Usa parte do email como username</span>
            <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="c1"># Limpa a sessão e redireciona para home</span>
            <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;socialaccount_sociallogin&quot;</span><span class="p">]</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Faz login manual do usuário</span>
            <span class="n">login</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;django.contrib.auth.backends.ModelBackend&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_success_url</span><span class="p">())</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">simular_troca_cargo</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="n">unidade_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unidade_id&#39;</span><span class="p">)</span>
        <span class="n">cargo_atual</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cargo_atual&#39;</span><span class="p">)</span>
        <span class="n">cargo_novo</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cargo_novo&#39;</span><span class="p">)</span>
        
        <span class="c1"># Buscar valores dos cargos</span>
        <span class="n">cargo_atual_siorg</span> <span class="o">=</span> <span class="n">CargoSIORG</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">cargo</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cargo_atual</span><span class="p">[</span><span class="s1">&#39;tipo&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">cargo_atual</span><span class="p">[</span><span class="s1">&#39;categoria&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">cargo_atual</span><span class="p">[</span><span class="s1">&#39;nivel&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        
        <span class="n">cargo_novo_siorg</span> <span class="o">=</span> <span class="n">CargoSIORG</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">cargo</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cargo_novo</span><span class="p">[</span><span class="s1">&#39;tipo&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">cargo_novo</span><span class="p">[</span><span class="s1">&#39;categoria&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">cargo_novo</span><span class="p">[</span><span class="s1">&#39;nivel&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cargo_atual_siorg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cargo_novo_siorg</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Cargo não encontrado&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
        
        <span class="c1"># Calcular diferenças</span>
        <span class="n">diferenca_valor</span> <span class="o">=</span> <span class="p">(</span><span class="n">cargo_novo_siorg</span><span class="o">.</span><span class="n">unitario</span> <span class="o">-</span> <span class="n">cargo_atual_siorg</span><span class="o">.</span><span class="n">unitario</span><span class="p">)</span> <span class="o">*</span> <span class="n">cargo_atual</span><span class="p">[</span><span class="s1">&#39;quantidade&#39;</span><span class="p">]</span>
        <span class="n">diferenca_pontos</span> <span class="o">=</span> <span class="p">(</span><span class="n">cargo_novo_siorg</span><span class="o">.</span><span class="n">valor</span> <span class="o">-</span> <span class="n">cargo_atual_siorg</span><span class="o">.</span><span class="n">valor</span><span class="p">)</span> <span class="o">*</span> <span class="n">cargo_atual</span><span class="p">[</span><span class="s1">&#39;quantidade&#39;</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;diferenca_valor&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">diferenca_valor</span><span class="p">),</span>
            <span class="s1">&#39;diferenca_pontos&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">diferenca_pontos</span><span class="p">),</span>
            <span class="s1">&#39;valor_atual&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">cargo_atual_siorg</span><span class="o">.</span><span class="n">valor</span> <span class="o">*</span> <span class="n">cargo_atual</span><span class="p">[</span><span class="s1">&#39;quantidade&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;valor_novo&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">cargo_novo_siorg</span><span class="o">.</span><span class="n">valor</span> <span class="o">*</span> <span class="n">cargo_atual</span><span class="p">[</span><span class="s1">&#39;quantidade&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;pontos_atual&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">cargo_atual_siorg</span><span class="o">.</span><span class="n">unitario</span> <span class="o">*</span> <span class="n">cargo_atual</span><span class="p">[</span><span class="s1">&#39;quantidade&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;pontos_novo&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">cargo_novo_siorg</span><span class="o">.</span><span class="n">unitario</span> <span class="o">*</span> <span class="n">cargo_atual</span><span class="p">[</span><span class="s1">&#39;quantidade&#39;</span><span class="p">])</span>
        <span class="p">})</span>
    
    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Método não permitido&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">405</span><span class="p">)</span>


<span class="nd">@login_required</span>
<span class="nd">@require_http_methods</span><span class="p">([</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">view_organograma</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;View para exibir o organograma visual com D3.js&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;organograma.html&#39;</span><span class="p">)</span>


<span class="nd">@require_http_methods</span><span class="p">([</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_organograma</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;API endpoint para fornecer os dados do organograma diretamente do banco de dados&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Usar o mesmo arquivo JSON que usamos para o template</span>
        <span class="n">json_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;core&#39;</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;organograma.json&#39;</span><span class="p">)</span>
        
        <span class="c1"># Verificar se o arquivo existe</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">json_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Arquivo organograma.json não encontrado. Execute uma atualização no Admin primeiro.&#39;</span>
            <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>
            
        <span class="c1"># Carregar os dados</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">dados</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
        <span class="c1"># Se dados é uma lista com um único item, extrair esse item</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dados</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dados</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dados</span> <span class="o">=</span> <span class="n">dados</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
        <span class="c1"># Retornar os dados sem modificações adicionais</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">dados</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao decodificar organograma.json: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Erro ao decodificar o arquivo de dados: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;core_unidadecargo&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
        <span class="n">traceback_str</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro em api_organograma: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">traceback_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Erro inesperado: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;stack_trace&#39;</span><span class="p">:</span> <span class="n">traceback_str</span><span class="p">,</span>
            <span class="s1">&#39;core_unidadecargo&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>


<span class="nd">@require_http_methods</span><span class="p">([</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">teste_api_organograma</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;API endpoint para fornecer os dados do organograma diretamente do banco de dados (para teste)&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Usar o dados.json para servir ao organograma</span>
        <span class="n">dados_json_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))),</span> <span class="s1">&#39;dados.json&#39;</span><span class="p">)</span>
        
        <span class="c1"># Verificar se o arquivo existe</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dados_json_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Arquivo dados.json não encontrado. Execute uma atualização no Admin primeiro.&#39;</span>
            <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>
            
        <span class="c1"># Carregar os dados</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dados_json_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">dados</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
        <span class="c1"># Verificar formato dos dados</span>
        <span class="n">dados_validos</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dados</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;unidades&quot;</span> <span class="ow">in</span> <span class="n">dados</span><span class="p">:</span>
            <span class="n">dados_validos</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dados</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dados</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dados_validos</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">dados</span> <span class="o">=</span> <span class="n">dados</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dados</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">dados</span>
        
        <span class="c1"># Para teste, adicionar informações extras</span>
        <span class="n">dados_debug</span> <span class="o">=</span> <span class="n">dados</span> <span class="k">if</span> <span class="n">dados_validos</span> <span class="k">else</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Formato de dados inválido ou vazio&#39;</span><span class="p">}</span>
        
        <span class="c1"># Adicionar informações de debug</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dados_debug</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">dados_debug</span><span class="p">[</span><span class="s1">&#39;_debug_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;tipo&#39;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">dados</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="s1">&#39;tamanho&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dados</span><span class="p">)),</span>
                <span class="s1">&#39;chaves&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">dados</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dados</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]),</span>
                <span class="s1">&#39;unidades_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">dados</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unidades&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dados</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]),</span>
                <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">dados_json_path</span><span class="p">,</span>
                <span class="s1">&#39;valido&#39;</span><span class="p">:</span> <span class="n">dados_validos</span>
            <span class="p">}</span>
        
        <span class="c1"># Retornar os dados brutos para inspeção</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">dados_debug</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> 
                          <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span><span class="p">)</span>
    
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Erro ao decodificar o arquivo de dados: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Erro inesperado: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>


<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">perfil</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exibe a página de perfil do usuário.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;core/perfil/perfil.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;perfil&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">perfil</span>
    <span class="p">})</span>

<div class="viewcode-block" id="editar_perfil">
<a class="viewcode-back" href="../../api/views.html#core.views.editar_perfil">[documentos]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">editar_perfil</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Permite ao usuário editar suas informações de perfil.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">user_form</span> <span class="o">=</span> <span class="n">UserUpdateForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">perfil_form</span> <span class="o">=</span> <span class="n">PerfilUpdateForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">perfil</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">user_form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span> <span class="ow">and</span> <span class="n">perfil_form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">user_form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">perfil_form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            
            <span class="c1"># Se o usuário solicitou a remoção da foto</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;delete_foto&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">perfil</span><span class="o">.</span><span class="n">foto</span><span class="p">:</span>
                <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">perfil</span><span class="o">.</span><span class="n">foto</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">perfil</span><span class="o">.</span><span class="n">foto</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">perfil</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Perfil atualizado com sucesso!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;perfil&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">user_form</span> <span class="o">=</span> <span class="n">UserUpdateForm</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">perfil_form</span> <span class="o">=</span> <span class="n">PerfilUpdateForm</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">perfil</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;core/perfil/editar_perfil.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;user_form&#39;</span><span class="p">:</span> <span class="n">user_form</span><span class="p">,</span>
        <span class="s1">&#39;perfil_form&#39;</span><span class="p">:</span> <span class="n">perfil_form</span>
    <span class="p">})</span></div>


<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">alterar_senha</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Permite ao usuário alterar sua senha.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CustomPasswordChangeForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">update_session_auth_hash</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Sua senha foi alterada com sucesso!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;perfil&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CustomPasswordChangeForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;core/perfil/alterar_senha.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span>
    <span class="p">})</span>

<span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># Filtrar para mostrar apenas unidades com grafo válido</span>
    <span class="n">unidades_validas</span> <span class="o">=</span> <span class="n">UnidadeCargo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
        <span class="n">Q</span><span class="p">(</span><span class="n">grafo__exact</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">grafo__isnull</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span>
    
    <span class="c1"># Contar registros totais e filtrados</span>
    <span class="n">total_registros</span> <span class="o">=</span> <span class="n">UnidadeCargo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">total_validos</span> <span class="o">=</span> <span class="n">unidades_validas</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    
    <span class="c1"># Construir contexto</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Dashboard NEXO&#39;</span><span class="p">,</span>
        <span class="s1">&#39;unidades&#39;</span><span class="p">:</span> <span class="n">unidades_validas</span><span class="p">,</span>
        <span class="s1">&#39;total_registros&#39;</span><span class="p">:</span> <span class="n">total_registros</span><span class="p">,</span>
        <span class="s1">&#39;total_validos&#39;</span><span class="p">:</span> <span class="n">total_validos</span><span class="p">,</span>
        <span class="s1">&#39;registros_filtrados&#39;</span><span class="p">:</span> <span class="n">total_registros</span> <span class="o">-</span> <span class="n">total_validos</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;core/index.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_unidade_data</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">codigo_unidade</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Garantir que só buscamos unidades com grafos válidos</span>
        <span class="n">unidade</span> <span class="o">=</span> <span class="n">UnidadeCargo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
            <span class="n">Q</span><span class="p">(</span><span class="n">grafo__exact</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">grafo__isnull</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">codigo_unidade</span><span class="o">=</span><span class="n">codigo_unidade</span><span class="p">)</span>
        
        <span class="c1"># Converter o grafo de string JSON para objeto Python</span>
        <span class="n">grafo_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">unidade</span><span class="o">.</span><span class="n">grafo</span><span class="p">)</span> <span class="k">if</span> <span class="n">unidade</span><span class="o">.</span><span class="n">grafo</span> <span class="k">else</span> <span class="p">{}</span>
        
        <span class="c1"># Construir resposta</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;unidade&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;codigo&#39;</span><span class="p">:</span> <span class="n">unidade</span><span class="o">.</span><span class="n">codigo_unidade</span><span class="p">,</span>
                <span class="s1">&#39;denominacao&#39;</span><span class="p">:</span> <span class="n">unidade</span><span class="o">.</span><span class="n">denominacao_unidade</span><span class="p">,</span>
                <span class="s1">&#39;tipo_cargo&#39;</span><span class="p">:</span> <span class="n">unidade</span><span class="o">.</span><span class="n">tipo_cargo</span><span class="p">,</span>
                <span class="s1">&#39;categoria&#39;</span><span class="p">:</span> <span class="n">unidade</span><span class="o">.</span><span class="n">categoria</span><span class="p">,</span>
                <span class="s1">&#39;nivel&#39;</span><span class="p">:</span> <span class="n">unidade</span><span class="o">.</span><span class="n">nivel</span><span class="p">,</span>
                <span class="s1">&#39;grafo&#39;</span><span class="p">:</span> <span class="n">grafo_data</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="n">UnidadeCargo</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Unidade não encontrada ou sem estrutura válida&#39;</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Erro ao decodificar os dados do grafo&#39;</span>
        <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_organograma_detalhes</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">codigo</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API para obter detalhes específicos de uma unidade pelo código.</span>
<span class="sd">    Esta API é usada para carregar detalhes sob demanda no organograma.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Usar o dados.json para buscar detalhes da unidade</span>
        <span class="n">dados_json_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))),</span> <span class="s1">&#39;dados.json&#39;</span><span class="p">)</span>
        
        <span class="c1"># Verificar se o arquivo existe</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dados_json_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Arquivo dados.json não encontrado. Execute uma atualização no Admin primeiro.&#39;</span>
            <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>
            
        <span class="c1"># Carregar o arquivo dados.json</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dados_json_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">dados</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            
        <span class="c1"># Buscar a unidade específica pelo código</span>
        <span class="n">unidade</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">dados</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unidades&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">u</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;codigo&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">codigo</span><span class="p">):</span>
                <span class="n">unidade</span> <span class="o">=</span> <span class="n">u</span>
                <span class="k">break</span>
                
        <span class="k">if</span> <span class="ow">not</span> <span class="n">unidade</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Unidade com código </span><span class="si">{</span><span class="n">codigo</span><span class="si">}</span><span class="s1"> não encontrada&#39;</span>
            <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>
            
        <span class="c1"># Retornar os detalhes da unidade</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">unidade</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Erro ao buscar detalhes da unidade: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">organograma_ondemand</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualização do organograma com carregamento sob demanda.</span>
<span class="sd">    Esta versão carrega os dados de forma incremental para evitar</span>
<span class="sd">    travamentos no navegador.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;core/organograma_ondemand.html&#39;</span><span class="p">)</span>

<span class="nd">@csrf_exempt</span>
<span class="k">def</span><span class="w"> </span><span class="nf">atualizar_organograma_json</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;View para forçar atualização do arquivo organograma.json via AJAX&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">gerar_organograma_json</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Arquivo organograma.json atualizado com sucesso.&#39;</span><span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Erro ao atualizar: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Método não permitido.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">405</span><span class="p">)</span>

<span class="nd">@require_http_methods</span><span class="p">([</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_organograma_filter</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;API endpoint para filtrar dados do organograma de forma otimizada preservando estrutura hierárquica&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">JsonResponse</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Q</span>
    
    <span class="c1"># Obter parâmetros de filtro</span>
    <span class="n">sigla</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sigla&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">cargo</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cargo&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">nivel</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nivel&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    
    <span class="c1"># Caminho para o JSON original</span>
    <span class="n">json_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;core&#39;</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;organograma.json&#39;</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Carregar dados do JSON</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            
            <span class="c1"># Se não há filtros, retornar dados completos</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sigla</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cargo</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">nivel</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            
            <span class="c1"># Estes serão os códigos de unidades filtradas + todos os seus ancestrais e descendentes</span>
            <span class="n">codigos_para_incluir</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            
            <span class="c1"># Lista de todas as unidades</span>
            <span class="n">units</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;core_unidadecargo&#39;</span><span class="p">,</span> <span class="p">[])</span>
            
            <span class="c1"># Primeiro, identificar unidades que atendem aos critérios de filtro</span>
            <span class="n">filtered_codes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
                <span class="c1"># Se passa pelos filtros</span>
                <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="n">sigla</span> <span class="ow">or</span> <span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sigla&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">sigla</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="ow">not</span> <span class="n">cargo</span> <span class="ow">or</span> <span class="n">unit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tipo_cargo&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">cargo</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="ow">not</span> <span class="n">nivel</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nivel&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="n">nivel</span><span class="p">)):</span>
                    <span class="n">filtered_codes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;codigo_unidade&#39;</span><span class="p">))</span>
                    <span class="n">codigos_para_incluir</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;codigo_unidade&#39;</span><span class="p">))</span>
            
            <span class="c1"># Para cada código filtrado, adicionar ancestrais e descendentes</span>
            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
                <span class="c1"># Se esta unidade foi filtrada, adicionar ascendentes e descendentes</span>
                <span class="k">if</span> <span class="n">unit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;codigo_unidade&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">filtered_codes</span><span class="p">:</span>
                    <span class="n">grafo</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grafo&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">grafo</span><span class="p">:</span>
                        <span class="c1"># Adicionar ancestrais (todos os segmentos do grafo são ancestrais)</span>
                        <span class="n">ancestrais</span> <span class="o">=</span> <span class="n">grafo</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">ancestral</span> <span class="ow">in</span> <span class="n">ancestrais</span><span class="p">:</span>
                            <span class="n">codigos_para_incluir</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ancestral</span><span class="p">)</span>
                
                <span class="c1"># Verificar se é descendente de alguma unidade filtrada</span>
                <span class="n">grafo</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grafo&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">grafo</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">filtered_code</span> <span class="ow">in</span> <span class="n">filtered_codes</span><span class="p">:</span>
                        <span class="c1"># Se o grafo contém o código filtrado como um segmento, é descendente</span>
                        <span class="n">segments</span> <span class="o">=</span> <span class="n">grafo</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">filtered_code</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">:</span>
                            <span class="n">codigos_para_incluir</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;codigo_unidade&#39;</span><span class="p">))</span>
                            <span class="k">break</span>
            
            <span class="c1"># Criar uma nova lista incluindo apenas unidades da hierarquia filtrada</span>
            <span class="n">filtered_units</span> <span class="o">=</span> <span class="p">[</span><span class="n">unit</span> <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span> <span class="k">if</span> <span class="n">unit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;codigo_unidade&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">codigos_para_incluir</span><span class="p">]</span>
            
            <span class="c1"># Substituir dados originais com dados filtrados</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;core_unidadecargo&#39;</span><span class="p">:</span> <span class="n">filtered_units</span><span class="p">,</span>
                <span class="s1">&#39;core_cargosiorg&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;core_cargosiorg&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="p">}</span>
            
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Log do erro</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao filtrar dados do organograma: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Retornar dados de fallback em caso de erro</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s2">&quot;core_unidadecargo&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;tipo_unidade&quot;</span><span class="p">:</span> <span class="s2">&quot;Órgão&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;denominacao_unidade&quot;</span><span class="p">:</span> <span class="s2">&quot;Ministério do Planejamento e Orçamento - MPO&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;codigo_unidade&quot;</span><span class="p">:</span> <span class="s2">&quot;308804&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;sigla&quot;</span><span class="p">:</span> <span class="s2">&quot;MPO&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;tipo_cargo&quot;</span><span class="p">:</span> <span class="s2">&quot;MEST&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;denominacao&quot;</span><span class="p">:</span> <span class="s2">&quot;Ministro de Estado&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;categoria&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;nivel&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;quantidade&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;grafo&quot;</span><span class="p">:</span> <span class="s2">&quot;308804&quot;</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;core_cargosiorg&quot;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">})</span>

<span class="nd">@require_http_methods</span><span class="p">([</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_cargos</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;API endpoint para buscar dados de cargos de forma específica (para a tabela)&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">JsonResponse</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">UnidadeCargo</span>
    
    <span class="c1"># Obter parâmetros de filtro</span>
    <span class="n">sigla</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sigla&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">tipo_cargo</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tipo_cargo&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">nivel</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nivel&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Construir a query base</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">UnidadeCargo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        
        <span class="c1"># Aplicar filtros</span>
        <span class="k">if</span> <span class="n">sigla</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">sigla__icontains</span><span class="o">=</span><span class="n">sigla</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">tipo_cargo</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tipo_cargo</span><span class="o">=</span><span class="n">tipo_cargo</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">nivel</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">nivel</span><span class="o">=</span><span class="n">nivel</span><span class="p">)</span>
            
        <span class="c1"># Executar a consulta</span>
        <span class="n">cargos</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;unidade&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-nivel&#39;</span><span class="p">)</span>
        
        <span class="c1"># Converter para o formato esperado pelo frontend</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cargo</span> <span class="ow">in</span> <span class="n">cargos</span><span class="p">:</span>
            <span class="c1"># Calcular valores derivados</span>
            <span class="n">pontos</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cargo</span><span class="o">.</span><span class="n">pontos</span><span class="p">)</span> <span class="k">if</span> <span class="n">cargo</span><span class="o">.</span><span class="n">pontos</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">quantidade</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cargo</span><span class="o">.</span><span class="n">quantidade</span><span class="p">)</span> <span class="k">if</span> <span class="n">cargo</span><span class="o">.</span><span class="n">quantidade</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">valor_unitario</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cargo</span><span class="o">.</span><span class="n">valor_unitario</span><span class="p">)</span> <span class="k">if</span> <span class="n">cargo</span><span class="o">.</span><span class="n">valor_unitario</span> <span class="k">else</span> <span class="mi">0</span>
            
            <span class="c1"># Calcular pontos_total e gasto_total</span>
            <span class="n">pontos_total</span> <span class="o">=</span> <span class="n">pontos</span> <span class="o">*</span> <span class="n">quantidade</span>
            <span class="n">gasto_total</span> <span class="o">=</span> <span class="n">pontos</span> <span class="o">*</span> <span class="n">quantidade</span> <span class="o">*</span> <span class="n">valor_unitario</span>
            
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;codigo_unidade&#39;</span><span class="p">:</span> <span class="n">cargo</span><span class="o">.</span><span class="n">unidade</span><span class="o">.</span><span class="n">codigo</span> <span class="k">if</span> <span class="n">cargo</span><span class="o">.</span><span class="n">unidade</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sigla&#39;</span><span class="p">:</span> <span class="n">cargo</span><span class="o">.</span><span class="n">sigla</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tipo_unidade&#39;</span><span class="p">:</span> <span class="n">cargo</span><span class="o">.</span><span class="n">tipo_unidade</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;denominacao_unidade&#39;</span><span class="p">:</span> <span class="n">cargo</span><span class="o">.</span><span class="n">denominacao_unidade</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tipo_cargo&#39;</span><span class="p">:</span> <span class="n">cargo</span><span class="o">.</span><span class="n">tipo_cargo</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;denominacao&#39;</span><span class="p">:</span> <span class="n">cargo</span><span class="o">.</span><span class="n">denominacao</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;categoria&#39;</span><span class="p">:</span> <span class="n">cargo</span><span class="o">.</span><span class="n">categoria</span><span class="p">,</span>
                <span class="s1">&#39;nivel&#39;</span><span class="p">:</span> <span class="n">cargo</span><span class="o">.</span><span class="n">nivel</span><span class="p">,</span>
                <span class="s1">&#39;quantidade&#39;</span><span class="p">:</span> <span class="n">quantidade</span><span class="p">,</span>
                <span class="s1">&#39;pontos&#39;</span><span class="p">:</span> <span class="n">pontos</span><span class="p">,</span>
                <span class="s1">&#39;valor_unitario&#39;</span><span class="p">:</span> <span class="n">valor_unitario</span><span class="p">,</span>
                <span class="s1">&#39;pontos_total&#39;</span><span class="p">:</span> <span class="n">pontos_total</span><span class="p">,</span>
                <span class="s1">&#39;gasto_total&#39;</span><span class="p">:</span> <span class="n">gasto_total</span><span class="p">,</span>
                <span class="s1">&#39;grafo&#39;</span><span class="p">:</span> <span class="n">cargo</span><span class="o">.</span><span class="n">grafo</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
            <span class="p">})</span>
            
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;dados&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">})</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Log do erro</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao buscar dados de cargos: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Retornar dados de fallback em caso de erro</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;erro&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Ocorreu um erro ao buscar os dados: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;dados&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_cargos_diretos</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;API endpoint para buscar dados de cargos diretamente do banco de dados com paginação&quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">JsonResponse</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">UnidadeCargo</span><span class="p">,</span> <span class="n">CargoSIORG</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">django.core.paginator</span><span class="w"> </span><span class="kn">import</span> <span class="n">Paginator</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">decimal</span>
    <span class="c1"># Importações para construir query OR</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">reduce</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">operator</span>

    <span class="c1"># Configurar logging</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    
    <span class="c1"># Obter parâmetros de filtro e paginação</span>
    <span class="n">sigla</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sigla&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">tipo_cargo</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tipo_cargo&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">nivel</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nivel&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    
    <span class="c1"># Parâmetros de paginação</span>
    <span class="n">pagina</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pagina&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">tamanho</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tamanho&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;API cargos_diretos - Parâmetros: sigla=</span><span class="si">{</span><span class="n">sigla</span><span class="si">}</span><span class="s2">, tipo_cargo=</span><span class="si">{</span><span class="n">tipo_cargo</span><span class="si">}</span><span class="s2">, nivel=</span><span class="si">{</span><span class="n">nivel</span><span class="si">}</span><span class="s2">, pagina=</span><span class="si">{</span><span class="n">pagina</span><span class="si">}</span><span class="s2">, tamanho=</span><span class="si">{</span><span class="n">tamanho</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Consulta base</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">UnidadeCargo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total de registros na tabela UnidadeCargo: </span><span class="si">{</span><span class="n">query</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Se houver sigla, aplicar filtro especial</span>
        <span class="k">if</span> <span class="n">sigla</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iniciando processamento de filtro por sigla: </span><span class="si">{</span><span class="n">sigla</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Buscamos registros onde a sigla aparece diretamente (nos campos indicados)</span>
            <span class="n">codigos_associados</span> <span class="o">=</span> <span class="n">UnidadeCargo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Q</span><span class="p">(</span><span class="n">sigla_unidade__icontains</span><span class="o">=</span><span class="n">sigla</span><span class="p">)</span> <span class="o">|</span> 
                <span class="n">Q</span><span class="p">(</span><span class="n">sigla__icontains</span><span class="o">=</span><span class="n">sigla</span><span class="p">)</span> <span class="o">|</span>
                <span class="n">Q</span><span class="p">(</span><span class="n">denominacao_unidade__icontains</span><span class="o">=</span><span class="n">sigla</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;codigo_unidade&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
            
            <span class="n">codigos_lista</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">codigos_associados</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Códigos de unidade associados à sigla &#39;</span><span class="si">{</span><span class="n">sigla</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">codigos_lista</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span><span class="si">}</span><span class="s2"> (total: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">codigos_lista</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">codigos_lista</span><span class="p">:</span>
                <span class="c1"># Em vez de usar somente a união dos códigos, usamos um filtro OR:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">Q</span><span class="p">(</span><span class="n">codigo_unidade__in</span><span class="o">=</span><span class="n">codigos_lista</span><span class="p">)</span> <span class="o">|</span>
                    <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">or_</span><span class="p">,</span> <span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">grafo__icontains</span><span class="o">=</span><span class="n">code</span><span class="p">)</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">codigos_lista</span><span class="p">))</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtrando registros com código ou grafo contendo os códigos. Resultados: </span><span class="si">{</span><span class="n">query</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2"> registros&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Fallback: se não houver códigos associados, usa filtro tradicional</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">Q</span><span class="p">(</span><span class="n">sigla_unidade__icontains</span><span class="o">=</span><span class="n">sigla</span><span class="p">)</span> <span class="o">|</span> 
                    <span class="n">Q</span><span class="p">(</span><span class="n">sigla__icontains</span><span class="o">=</span><span class="n">sigla</span><span class="p">)</span> <span class="o">|</span>
                    <span class="n">Q</span><span class="p">(</span><span class="n">denominacao_unidade__icontains</span><span class="o">=</span><span class="n">sigla</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nenhum código associado encontrado. Usando filtro tradicional: </span><span class="si">{</span><span class="n">query</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2"> registros&quot;</span><span class="p">)</span>
        
        <span class="c1"># Aplicar os demais filtros (tipo_cargo, nivel)</span>
        <span class="k">if</span> <span class="n">tipo_cargo</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tipo_cargo</span><span class="o">=</span><span class="n">tipo_cargo</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Após filtro tipo_cargo=</span><span class="si">{</span><span class="n">tipo_cargo</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">query</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2"> registros&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">nivel</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">nivel</span><span class="o">=</span><span class="n">nivel</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Após filtro nivel=</span><span class="si">{</span><span class="n">nivel</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">query</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2"> registros&quot;</span><span class="p">)</span>
        
        <span class="c1"># Ordenar por sigla e nível</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;sigla_unidade&#39;</span><span class="p">,</span> <span class="s1">&#39;-nivel&#39;</span><span class="p">)</span>
        
        <span class="n">total_registros</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">total_registros</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nenhum registro encontrado com os filtros: sigla=</span><span class="si">{</span><span class="n">sigla</span><span class="si">}</span><span class="s2">, tipo_cargo=</span><span class="si">{</span><span class="n">tipo_cargo</span><span class="si">}</span><span class="s2">, nivel=</span><span class="si">{</span><span class="n">nivel</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
                <span class="s1">&#39;cargos&#39;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s1">&#39;total_itens&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;total_paginas&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;pagina_atual&#39;</span><span class="p">:</span> <span class="n">pagina</span><span class="p">,</span>
                <span class="s1">&#39;itens_por_pagina&#39;</span><span class="p">:</span> <span class="n">tamanho</span>
            <span class="p">})</span>
        
        <span class="c1"># Carregar os cargos do SIORG para matching</span>
        <span class="n">cargos_siorg_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cs</span> <span class="ow">in</span> <span class="n">CargoSIORG</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">key1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cs</span><span class="o">.</span><span class="n">cargo</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">key2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cs</span><span class="o">.</span><span class="n">cargo</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                
                <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\w+)\s+(\d+)\s+(\d+)&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="o">.</span><span class="n">cargo</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">tipo</span><span class="p">,</span> <span class="n">categoria</span><span class="p">,</span> <span class="n">nivel_cargo</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                    <span class="n">key3</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tipo</span><span class="si">}{</span><span class="n">categoria</span><span class="si">}{</span><span class="n">nivel_cargo</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">key4</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tipo</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">categoria</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">nivel_cargo</span><span class="si">}</span><span class="s2">&quot;</span>
                    
                    <span class="n">cargos_siorg_dict</span><span class="p">[</span><span class="n">key1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span>
                    <span class="n">cargos_siorg_dict</span><span class="p">[</span><span class="n">key2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span>
                    <span class="n">cargos_siorg_dict</span><span class="p">[</span><span class="n">key3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span>
                    <span class="n">cargos_siorg_dict</span><span class="p">[</span><span class="n">key4</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cargos_siorg_dict</span><span class="p">[</span><span class="n">key1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span>
                    <span class="n">cargos_siorg_dict</span><span class="p">[</span><span class="n">key2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Carregados </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cargos_siorg_dict</span><span class="p">)</span><span class="si">}</span><span class="s2"> cargos SIORG para referência&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao carregar cargos SIORG: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Paginação</span>
        <span class="n">paginator</span> <span class="o">=</span> <span class="n">Paginator</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">tamanho</span><span class="p">)</span>
        <span class="n">page_obj</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">get_page</span><span class="p">(</span><span class="n">pagina</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Paginação: total_registros=</span><span class="si">{</span><span class="n">total_registros</span><span class="si">}</span><span class="s2">, total_paginas=</span><span class="si">{</span><span class="n">paginator</span><span class="o">.</span><span class="n">num_pages</span><span class="si">}</span><span class="s2">, pagina_atual=</span><span class="si">{</span><span class="n">pagina</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Converter resultados mantendo a lógica de cálculo original</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cargo</span> <span class="ow">in</span> <span class="n">page_obj</span><span class="p">:</span>
            <span class="n">quantidade</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cargo</span><span class="o">.</span><span class="n">quantidade</span><span class="p">)</span> <span class="k">if</span> <span class="n">cargo</span><span class="o">.</span><span class="n">quantidade</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">categoria</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cargo</span><span class="o">.</span><span class="n">categoria</span><span class="p">)</span> <span class="k">if</span> <span class="n">cargo</span><span class="o">.</span><span class="n">categoria</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">nivel_cargo</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cargo</span><span class="o">.</span><span class="n">nivel</span><span class="p">)</span> <span class="k">if</span> <span class="n">cargo</span><span class="o">.</span><span class="n">nivel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
            
            <span class="n">cargo_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cargo</span><span class="o">.</span><span class="n">tipo_cargo</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">categoria</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">nivel_cargo</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">cargo_key_alt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cargo</span><span class="o">.</span><span class="n">tipo_cargo</span><span class="si">}{</span><span class="n">categoria</span><span class="si">}{</span><span class="n">nivel_cargo</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>
            
            <span class="n">cargo_siorg</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="n">cargo_key</span><span class="p">,</span> <span class="n">cargo_key_alt</span><span class="p">,</span> <span class="n">cargo_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cargos_siorg_dict</span><span class="p">:</span>
                    <span class="n">cargo_siorg</span> <span class="o">=</span> <span class="n">cargos_siorg_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">break</span>
            
            <span class="n">pontos</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">valor_unitario</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">cargo_siorg</span><span class="p">:</span>
                <span class="n">pontos</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cargo_siorg</span><span class="o">.</span><span class="n">unitario</span><span class="p">)</span> <span class="k">if</span> <span class="n">cargo_siorg</span><span class="o">.</span><span class="n">unitario</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cargo_siorg</span><span class="o">.</span><span class="n">valor</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">valor_str</span> <span class="o">=</span> <span class="n">cargo_siorg</span><span class="o">.</span><span class="n">valor</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;R$ &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
                        <span class="n">valor_unitario</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">valor_str</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao converter valor &#39;</span><span class="si">{</span><span class="n">cargo_siorg</span><span class="o">.</span><span class="n">valor</span><span class="si">}</span><span class="s2">&#39; para float&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">valor_unitario</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cargo_siorg</span><span class="o">.</span><span class="n">valor</span><span class="p">)</span> <span class="k">if</span> <span class="n">cargo_siorg</span><span class="o">.</span><span class="n">valor</span> <span class="k">else</span> <span class="mi">0</span>
            
            <span class="k">if</span> <span class="n">pontos</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pontos_padrao</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="mi">18</span><span class="p">:</span> <span class="mf">7.65</span><span class="p">,</span> <span class="mi">17</span><span class="p">:</span> <span class="mf">7.08</span><span class="p">,</span> <span class="mi">16</span><span class="p">:</span> <span class="mf">6.23</span><span class="p">,</span> <span class="mi">15</span><span class="p">:</span> <span class="mf">5.41</span><span class="p">,</span> <span class="mi">14</span><span class="p">:</span> <span class="mf">4.63</span><span class="p">,</span>
                    <span class="mi">13</span><span class="p">:</span> <span class="mf">4.12</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span> <span class="mf">3.10</span><span class="p">,</span> <span class="mi">11</span><span class="p">:</span> <span class="mf">2.47</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span> <span class="mf">2.12</span><span class="p">,</span> <span class="mi">9</span><span class="p">:</span> <span class="mf">1.67</span><span class="p">,</span>
                    <span class="mi">8</span><span class="p">:</span> <span class="mf">1.60</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span> <span class="mf">1.39</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="mf">1.17</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mf">0.44</span><span class="p">,</span>
                    <span class="mi">3</span><span class="p">:</span> <span class="mf">0.37</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.21</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.12</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">pontos</span> <span class="o">=</span> <span class="n">pontos_padrao</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nivel_cargo</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">valor_unitario</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">valor_unitario</span> <span class="o">=</span> <span class="mf">100.0</span>
            
            <span class="n">pontos_total</span> <span class="o">=</span> <span class="n">pontos</span> <span class="o">*</span> <span class="n">quantidade</span>
            <span class="n">gasto_total</span> <span class="o">=</span> <span class="n">pontos_total</span> <span class="o">*</span> <span class="n">valor_unitario</span>
            
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="n">cargo</span><span class="o">.</span><span class="n">sigla_unidade</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;categoria_unidade&#39;</span><span class="p">:</span> <span class="n">cargo</span><span class="o">.</span><span class="n">tipo_unidade</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sigla_unidade&#39;</span><span class="p">:</span> <span class="n">cargo</span><span class="o">.</span><span class="n">sigla_unidade</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>  <span class="c1"># Campo explícito para compatibilidade</span>
                <span class="s1">&#39;tipo_unidade&#39;</span><span class="p">:</span> <span class="n">cargo</span><span class="o">.</span><span class="n">tipo_unidade</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>    <span class="c1"># Campo explícito para compatibilidade</span>
                <span class="s1">&#39;tipo_cargo&#39;</span><span class="p">:</span> <span class="n">cargo</span><span class="o">.</span><span class="n">tipo_cargo</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;denominacao&#39;</span><span class="p">:</span> <span class="n">cargo</span><span class="o">.</span><span class="n">denominacao</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;categoria&#39;</span><span class="p">:</span> <span class="n">categoria</span><span class="p">,</span>
                <span class="s1">&#39;nivel&#39;</span><span class="p">:</span> <span class="n">nivel_cargo</span><span class="p">,</span>
                <span class="s1">&#39;quantidade&#39;</span><span class="p">:</span> <span class="n">quantidade</span><span class="p">,</span>
                <span class="s1">&#39;pontos&#39;</span><span class="p">:</span> <span class="n">pontos</span><span class="p">,</span>
                <span class="s1">&#39;valor_unitario&#39;</span><span class="p">:</span> <span class="n">valor_unitario</span><span class="p">,</span>
                <span class="s1">&#39;pontos_totais&#39;</span><span class="p">:</span> <span class="n">pontos_total</span><span class="p">,</span>
                <span class="s1">&#39;gastos_totais&#39;</span><span class="p">:</span> <span class="n">gasto_total</span><span class="p">,</span>
                <span class="s1">&#39;grafo&#39;</span><span class="p">:</span> <span class="n">cargo</span><span class="o">.</span><span class="n">grafo</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># Include grafo field for hierarchical ordering</span>
            <span class="p">})</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dados formatados: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="si">}</span><span class="s2"> registros processados&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;cargos&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
            <span class="s1">&#39;total_itens&#39;</span><span class="p">:</span> <span class="n">paginator</span><span class="o">.</span><span class="n">count</span><span class="p">,</span>
            <span class="s1">&#39;total_paginas&#39;</span><span class="p">:</span> <span class="n">paginator</span><span class="o">.</span><span class="n">num_pages</span><span class="p">,</span>
            <span class="s1">&#39;pagina_atual&#39;</span><span class="p">:</span> <span class="n">pagina</span><span class="p">,</span>
            <span class="s1">&#39;itens_por_pagina&#39;</span><span class="p">:</span> <span class="n">tamanho</span>
        <span class="p">})</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao buscar dados diretos de cargos: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;erro&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Ocorreu um erro ao buscar os dados: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cargos&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;total_itens&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;total_paginas&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;pagina_atual&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;itens_por_pagina&#39;</span><span class="p">:</span> <span class="n">tamanho</span>
        <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">comparador</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Renderiza a página do comparador de organogramas.&quot;&quot;&quot;</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">estrutura_json_organograma</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">UnidadeCargo</span><span class="p">,</span> <span class="n">CargoSIORG</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
        
        <span class="c1"># Buscar dados diretamente do banco de dados</span>
        <span class="n">dados</span> <span class="o">=</span> <span class="n">estrutura_json_organograma</span><span class="p">()</span>
        
        <span class="c1"># Converter para string JSON para passar ao template</span>
        <span class="n">organograma_data_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
            <span class="s1">&#39;core_unidadecargo&#39;</span><span class="p">:</span> <span class="n">dados</span><span class="p">,</span>
            <span class="s1">&#39;core_cargosiorg&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;cargo&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cargo</span><span class="o">.</span><span class="n">cargo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s1">&#39;valor&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">cargo</span><span class="o">.</span><span class="n">valor</span><span class="p">),</span>
                    <span class="s1">&#39;unitario&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">cargo</span><span class="o">.</span><span class="n">unitario</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">cargo</span> <span class="ow">in</span> <span class="n">CargoSIORG</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="p">]</span>
        <span class="p">})</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Log do erro e usar dados mínimos como fallback</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao carregar dados do comparador: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">organograma_data_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
            <span class="s2">&quot;core_unidadecargo&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;core_cargosiorg&quot;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">})</span>
    
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;core/comparador.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;organograma_data&#39;</span><span class="p">:</span> <span class="n">organograma_data_json</span>
    <span class="p">})</span>

<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s2">&quot;/login_direct/&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">financeira</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    View para renderizar a página de monitoramento financeiro.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;core/financeira.html&#39;</span><span class="p">)</span>

<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s2">&quot;/login_direct/&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">financeira_data_real</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retorna dados financeiros REAIS do banco de dados em formato JSON.</span>
<span class="sd">    Utiliza os mesmos dados do organograma.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Obtém o período da requisição</span>
    <span class="n">periodo</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;periodo&#39;</span><span class="p">,</span> <span class="s1">&#39;Mês Atual&#39;</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Importar a mesma função utilizada pelo organograma</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">estrutura_json_organograma</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
        
        <span class="c1"># Obter os dados do organograma, que já contém valores de gastos e pontos</span>
        <span class="n">unidades_dados</span> <span class="o">=</span> <span class="n">estrutura_json_organograma</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">unidades_dados</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Nenhuma unidade encontrada&quot;</span><span class="p">)</span>
        
        <span class="c1"># Agrupar dados por departamento (código_unidade) e, paralelamente,</span>
        <span class="c1"># acumular os totais globais (incluindo a unidade raiz 308804).</span>

        <span class="n">departamentos</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">orcamento_total</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">executado_total</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">for</span> <span class="n">linha</span> <span class="ow">in</span> <span class="n">unidades_dados</span><span class="p">:</span>
            <span class="n">cod</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">linha</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;codigo_unidade&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

            <span class="n">pontos</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">linha</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pontos_total&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">gastos</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">linha</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gasto_total&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

            <span class="c1"># Atualiza os totais globais (inclui MPO)</span>
            <span class="n">orcamento_total</span> <span class="o">+=</span> <span class="n">pontos</span>
            <span class="n">executado_total</span> <span class="o">+=</span> <span class="n">gastos</span>

            <span class="c1"># Para a lista de unidades queremos EXCLUIR o MPO (308804)</span>
            <span class="k">if</span> <span class="n">cod</span> <span class="o">==</span> <span class="s1">&#39;308804&#39;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">cod</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">departamentos</span><span class="p">:</span>
                <span class="n">departamentos</span><span class="p">[</span><span class="n">cod</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;codigo&#39;</span><span class="p">:</span> <span class="n">cod</span><span class="p">,</span>
                    <span class="s1">&#39;nome&#39;</span><span class="p">:</span> <span class="n">linha</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;denominacao_unidade&#39;</span><span class="p">,</span> <span class="s1">&#39;Sem nome&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;orcamento&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s1">&#39;executado&#39;</span><span class="p">:</span> <span class="mf">0.0</span>
                <span class="p">}</span>

            <span class="n">departamentos</span><span class="p">[</span><span class="n">cod</span><span class="p">][</span><span class="s1">&#39;orcamento&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pontos</span>
            <span class="n">departamentos</span><span class="p">[</span><span class="n">cod</span><span class="p">][</span><span class="s1">&#39;executado&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">gastos</span>

        <span class="c1"># Converter em lista e calcular percentuais</span>
        <span class="n">unidades_financeiras</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">departamentos</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">orc</span> <span class="o">=</span> <span class="n">dep</span><span class="p">[</span><span class="s1">&#39;orcamento&#39;</span><span class="p">]</span>
            <span class="n">exe</span> <span class="o">=</span> <span class="n">dep</span><span class="p">[</span><span class="s1">&#39;executado&#39;</span><span class="p">]</span>
            <span class="n">pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">exe</span> <span class="o">/</span> <span class="n">orc</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">orc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

            <span class="n">dep</span><span class="p">[</span><span class="s1">&#39;percentual&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pct</span>
            <span class="n">dep</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Crítico&quot;</span> <span class="k">if</span> <span class="n">pct</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;Atenção&quot;</span> <span class="k">if</span> <span class="n">pct</span> <span class="o">&lt;</span> <span class="mi">80</span> <span class="k">else</span> <span class="s2">&quot;Adequado&quot;</span><span class="p">)</span>

            <span class="n">unidades_financeiras</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>

        <span class="c1"># Ordenar lista por Pontos (orcamento) decrescente</span>
        <span class="n">unidades_financeiras</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;orcamento&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Percentual e status gerais</span>
        <span class="n">percentual</span> <span class="o">=</span> <span class="p">(</span><span class="n">executado_total</span> <span class="o">/</span> <span class="n">orcamento_total</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">orcamento_total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;Crítico&quot;</span> <span class="k">if</span> <span class="n">percentual</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;Atenção&quot;</span> <span class="k">if</span> <span class="n">percentual</span> <span class="o">&lt;</span> <span class="mi">80</span> <span class="k">else</span> <span class="s2">&quot;Adequado&quot;</span><span class="p">)</span>
        
        <span class="c1"># Simular dados de execução mensal (como não temos dados históricos)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">dateutil.relativedelta</span><span class="w"> </span><span class="kn">import</span> <span class="n">relativedelta</span>
        
        <span class="n">execucao_mensal</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">meses</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Criar array com os últimos 6 meses</span>
        <span class="n">data_atual</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">data_mes</span> <span class="o">=</span> <span class="n">data_atual</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
            <span class="n">meses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_mes</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%b/%Y&quot;</span><span class="p">))</span>
        
        <span class="c1"># Calcular valor médio mensal para distribuição</span>
        <span class="n">valor_medio_mensal_orcamento</span> <span class="o">=</span> <span class="n">orcamento_total</span> <span class="o">/</span> <span class="mi">6</span>
        <span class="n">valor_medio_mensal_executado</span> <span class="o">=</span> <span class="n">executado_total</span> <span class="o">/</span> <span class="mi">6</span>
        
        <span class="c1"># Distribuir valores nos meses (de forma crescente para simular execução)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">meses</span><span class="p">):</span>
            <span class="n">fator</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">6</span>  <span class="c1"># Fator crescente de 1/6 até 1</span>
            
            <span class="n">execucao_mensal</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;mes&quot;</span><span class="p">:</span> <span class="n">mes</span><span class="p">,</span>
                <span class="s2">&quot;orcado&quot;</span><span class="p">:</span> <span class="n">valor_medio_mensal_orcamento</span><span class="p">,</span>
                <span class="s2">&quot;executado&quot;</span><span class="p">:</span> <span class="n">valor_medio_mensal_executado</span> <span class="o">*</span> <span class="n">fator</span>
            <span class="p">})</span>
        
        <span class="c1"># Preparação dos dados de resposta</span>
        <span class="n">dados</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;orcamento_total&quot;</span><span class="p">:</span> <span class="n">orcamento_total</span><span class="p">,</span>
            <span class="s2">&quot;executado_total&quot;</span><span class="p">:</span> <span class="n">executado_total</span><span class="p">,</span>
            <span class="s2">&quot;percentual_execucao&quot;</span><span class="p">:</span> <span class="n">percentual</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
            <span class="s2">&quot;variacao_periodo&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># Valor real precisa ser calculado com dados históricos</span>
            <span class="s2">&quot;unidades&quot;</span><span class="p">:</span> <span class="n">unidades_financeiras</span><span class="p">,</span>
            <span class="s2">&quot;execucao_mensal&quot;</span><span class="p">:</span> <span class="n">execucao_mensal</span><span class="p">,</span>
            <span class="s2">&quot;periodo&quot;</span><span class="p">:</span> <span class="n">periodo</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">dados</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Log do erro</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao processar dados financeiros reais: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Em caso de erro, retornar estrutura vazia mas válida</span>
        <span class="n">dados</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;orcamento_total&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;executado_total&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;percentual_execucao&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;Não disponível&quot;</span><span class="p">,</span>
            <span class="s2">&quot;variacao_periodo&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;unidades&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;execucao_mensal&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;periodo&quot;</span><span class="p">:</span> <span class="n">periodo</span><span class="p">,</span>
            <span class="s2">&quot;erro&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>  <span class="c1"># Incluir mensagem de erro para depuração</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">dados</span><span class="p">)</span>

<span class="nd">@require_http_methods</span><span class="p">([</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_financeira_organograma</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;API específica para a tela Financeira que devolve o mesmo JSON do organograma,</span>
<span class="sd">    mas em endpoint independente, evitando interferência entre páginas.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Mesmo arquivo JSON utilizado pela API de organograma</span>
        <span class="n">json_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;core&#39;</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;organograma.json&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">json_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Arquivo organograma.json não encontrado. Execute uma atualização no Admin primeiro.&#39;</span>
            <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">dados</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># Se dados for lista com item único, extrair</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dados</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dados</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dados</span> <span class="o">=</span> <span class="n">dados</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Retorna dados sem modificação</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">dados</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Erro ao decodificar o arquivo: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
        <span class="n">traceback_str</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Erro inesperado: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;stack_trace&#39;</span><span class="p">:</span> <span class="n">traceback_str</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BaixarAnexoSimulacaoView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
            <span class="n">estrutura_atual</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;estrutura_atual&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">estrutura_nova</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;estrutura_nova&#39;</span><span class="p">,</span> <span class="p">[])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">estrutura_atual</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">estrutura_nova</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid data format: estrutura_atual and estrutura_nova must be arrays.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

            <span class="c1"># Validate data before processing</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">estrutura_atual</span> <span class="o">+</span> <span class="n">estrutura_nova</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Invalid item at position </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: must be an object.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

            <span class="c1"># Call the utility function to generate the Excel file</span>
            <span class="n">excel_stream</span> <span class="o">=</span> <span class="n">gerar_anexo_simulacao</span><span class="p">(</span><span class="n">estrutura_atual</span><span class="p">,</span> <span class="n">estrutura_nova</span><span class="p">)</span>
            
            <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span>
                <span class="n">excel_stream</span><span class="p">,</span> 
                <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#39;</span>
            <span class="p">)</span>
            <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;attachment; filename=&quot;Anexo_Simulacao.xlsx&quot;&#39;</span>
            <span class="k">return</span> <span class="n">response</span>

        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid JSON&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
             <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span> <span class="c1"># e.g., no active template</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Log the full error for debugging</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ValueError in BaixarAnexoSimulacaoView: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;invalid literal for int()&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Erro de conversão de dados. Verifique se todos os campos numéricos estão preenchidos corretamente.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span> <span class="c1"># e.g., template sheet missing or multiple active</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Log the exception e for debugging</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in BaixarAnexoSimulacaoView: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Basic logging</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>  <span class="c1"># Print full traceback for debugging</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;An unexpected error occurred: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="nd">@login_required</span>
<span class="nd">@require_http_methods</span><span class="p">([</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">listar_simulacoes</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Lista todas as simulações salvas do usuário atual&quot;&quot;&quot;</span>
    <span class="n">simulacoes</span> <span class="o">=</span> <span class="n">SimulacaoSalva</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">usuario</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sim</span> <span class="ow">in</span> <span class="n">simulacoes</span><span class="p">:</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">sim</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;nome&#39;</span><span class="p">:</span> <span class="n">sim</span><span class="o">.</span><span class="n">nome</span><span class="p">,</span>
            <span class="s1">&#39;descricao&#39;</span><span class="p">:</span> <span class="n">sim</span><span class="o">.</span><span class="n">descricao</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;unidade_base&#39;</span><span class="p">:</span> <span class="n">sim</span><span class="o">.</span><span class="n">unidade_base</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;criado_em&#39;</span><span class="p">:</span> <span class="n">sim</span><span class="o">.</span><span class="n">criado_em</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">),</span>
            <span class="s1">&#39;atualizado_em&#39;</span><span class="p">:</span> <span class="n">sim</span><span class="o">.</span><span class="n">atualizado_em</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">)</span>
        <span class="p">})</span>
    
    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
        <span class="s1">&#39;simulacoes&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
        <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
        <span class="s1">&#39;limite&#39;</span><span class="p">:</span> <span class="mi">5</span>
    <span class="p">})</span>

<div class="viewcode-block" id="salvar_simulacao">
<a class="viewcode-back" href="../../api/views.html#core.views.salvar_simulacao">[documentos]</a>
<span class="nd">@login_required</span>
<span class="nd">@require_http_methods</span><span class="p">([</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">salvar_simulacao</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Salva uma nova simulação ou atualiza uma existente&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="n">nome</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nome&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">descricao</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;descricao&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">dados_estrutura</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dados_estrutura&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">unidade_base</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unidade_base&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">simulacao_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>  <span class="c1"># Para atualização</span>
        
        <span class="c1"># Validações</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nome</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;erro&#39;</span><span class="p">:</span> <span class="s1">&#39;Nome da simulação é obrigatório&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dados_estrutura</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;erro&#39;</span><span class="p">:</span> <span class="s1">&#39;Dados da estrutura são obrigatórios&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
        
        <span class="c1"># Verificar se é atualização ou criação</span>
        <span class="k">if</span> <span class="n">simulacao_id</span><span class="p">:</span>
            <span class="c1"># Atualização</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">simulacao</span> <span class="o">=</span> <span class="n">SimulacaoSalva</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">simulacao_id</span><span class="p">,</span> <span class="n">usuario</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
                <span class="n">simulacao</span><span class="o">.</span><span class="n">nome</span> <span class="o">=</span> <span class="n">nome</span>
                <span class="n">simulacao</span><span class="o">.</span><span class="n">descricao</span> <span class="o">=</span> <span class="n">descricao</span>
                <span class="n">simulacao</span><span class="o">.</span><span class="n">dados_estrutura</span> <span class="o">=</span> <span class="n">dados_estrutura</span>
                <span class="n">simulacao</span><span class="o">.</span><span class="n">unidade_base</span> <span class="o">=</span> <span class="n">unidade_base</span>
                <span class="n">simulacao</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
                    <span class="s1">&#39;mensagem&#39;</span><span class="p">:</span> <span class="s1">&#39;Simulação atualizada com sucesso&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">simulacao</span><span class="o">.</span><span class="n">id</span>
                <span class="p">})</span>
            <span class="k">except</span> <span class="n">SimulacaoSalva</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;erro&#39;</span><span class="p">:</span> <span class="s1">&#39;Simulação não encontrada&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Criação</span>
            <span class="c1"># Verificar limite de 5 simulações</span>
            <span class="n">total_simulacoes</span> <span class="o">=</span> <span class="n">SimulacaoSalva</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">usuario</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">total_simulacoes</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
                    <span class="s1">&#39;erro&#39;</span><span class="p">:</span> <span class="s1">&#39;Limite de 5 simulações atingido. Delete uma simulação existente antes de criar uma nova.&#39;</span>
                <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
            
            <span class="c1"># Verificar se já existe simulação com mesmo nome</span>
            <span class="k">if</span> <span class="n">SimulacaoSalva</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">usuario</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">nome</span><span class="o">=</span><span class="n">nome</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
                    <span class="s1">&#39;erro&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Já existe uma simulação com o nome &quot;</span><span class="si">{</span><span class="n">nome</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
                <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
            
            <span class="n">simulacao</span> <span class="o">=</span> <span class="n">SimulacaoSalva</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">usuario</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                <span class="n">nome</span><span class="o">=</span><span class="n">nome</span><span class="p">,</span>
                <span class="n">descricao</span><span class="o">=</span><span class="n">descricao</span><span class="p">,</span>
                <span class="n">dados_estrutura</span><span class="o">=</span><span class="n">dados_estrutura</span><span class="p">,</span>
                <span class="n">unidade_base</span><span class="o">=</span><span class="n">unidade_base</span>
            <span class="p">)</span>
            
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
                <span class="s1">&#39;mensagem&#39;</span><span class="p">:</span> <span class="s1">&#39;Simulação salva com sucesso&#39;</span><span class="p">,</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">simulacao</span><span class="o">.</span><span class="n">id</span>
            <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">201</span><span class="p">)</span>
            
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;erro&#39;</span><span class="p">:</span> <span class="s1">&#39;Dados inválidos&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;erro&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span></div>


<span class="nd">@login_required</span>
<span class="nd">@require_http_methods</span><span class="p">([</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">carregar_simulacao</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">simulacao_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Carrega os dados de uma simulação específica&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">simulacao</span> <span class="o">=</span> <span class="n">SimulacaoSalva</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">simulacao_id</span><span class="p">,</span> <span class="n">usuario</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">simulacao</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;nome&#39;</span><span class="p">:</span> <span class="n">simulacao</span><span class="o">.</span><span class="n">nome</span><span class="p">,</span>
            <span class="s1">&#39;descricao&#39;</span><span class="p">:</span> <span class="n">simulacao</span><span class="o">.</span><span class="n">descricao</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;dados_estrutura&#39;</span><span class="p">:</span> <span class="n">simulacao</span><span class="o">.</span><span class="n">dados_estrutura</span><span class="p">,</span>
            <span class="s1">&#39;unidade_base&#39;</span><span class="p">:</span> <span class="n">simulacao</span><span class="o">.</span><span class="n">unidade_base</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;criado_em&#39;</span><span class="p">:</span> <span class="n">simulacao</span><span class="o">.</span><span class="n">criado_em</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">),</span>
            <span class="s1">&#39;atualizado_em&#39;</span><span class="p">:</span> <span class="n">simulacao</span><span class="o">.</span><span class="n">atualizado_em</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="k">except</span> <span class="n">SimulacaoSalva</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;erro&#39;</span><span class="p">:</span> <span class="s1">&#39;Simulação não encontrada&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>

<span class="nd">@login_required</span>
<span class="nd">@require_http_methods</span><span class="p">([</span><span class="s2">&quot;DELETE&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">deletar_simulacao</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">simulacao_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Deleta uma simulação do usuário&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">simulacao</span> <span class="o">=</span> <span class="n">SimulacaoSalva</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">simulacao_id</span><span class="p">,</span> <span class="n">usuario</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">nome</span> <span class="o">=</span> <span class="n">simulacao</span><span class="o">.</span><span class="n">nome</span>
        <span class="n">simulacao</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;mensagem&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Simulação &quot;</span><span class="si">{</span><span class="n">nome</span><span class="si">}</span><span class="s1">&quot; deletada com sucesso&#39;</span>
        <span class="p">})</span>
    <span class="k">except</span> <span class="n">SimulacaoSalva</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;erro&#39;</span><span class="p">:</span> <span class="s1">&#39;Simulação não encontrada&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>


<span class="c1"># === VIEWS PARA SISTEMA DE RELATÓRIOS ===</span>

<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">relatorios</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Página principal do sistema de relatórios.</span>
<span class="sd">    Inclui todas as funcionalidades solicitadas.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">RelatorioGratificacoes</span><span class="p">,</span> <span class="n">RelatorioOrgaosCentrais</span><span class="p">,</span> <span class="n">RelatorioEfetivo</span><span class="p">,</span> <span class="n">UnidadeCargo</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Count</span><span class="p">,</span> <span class="n">Sum</span><span class="p">,</span> <span class="n">Avg</span>
    
    <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c1"># Dados para o relatório de pontos e gratificações</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Estatísticas básicas</span>
        <span class="n">total_servidores</span> <span class="o">=</span> <span class="n">RelatorioGratificacoes</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">total_unidades</span> <span class="o">=</span> <span class="n">RelatorioGratificacoes</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">&#39;unidade_lotacao&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">total_cargos</span> <span class="o">=</span> <span class="n">RelatorioGratificacoes</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">&#39;cargo&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        
        <span class="c1"># Dados por unidade para cálculo dos índices</span>
        <span class="n">unidades_data</span> <span class="o">=</span> <span class="n">RelatorioGratificacoes</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span>
            <span class="s1">&#39;unidade_lotacao&#39;</span><span class="p">,</span> <span class="s1">&#39;sigla_unidade&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">total_servidores</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span>
            <span class="n">cargos_unicos</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s1">&#39;cargo&#39;</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-total_servidores&#39;</span><span class="p">)</span>
        
        <span class="c1"># Dados do organograma para cálculo de pontos</span>
        <span class="n">pontos_data</span> <span class="o">=</span> <span class="n">UnidadeCargo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span>
            <span class="s1">&#39;denominacao_unidade&#39;</span><span class="p">,</span> <span class="s1">&#39;sigla_unidade&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">total_pontos</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;pontos_total&#39;</span><span class="p">),</span>
            <span class="n">total_quantidade</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;quantidade&#39;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">total_pontos__gt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;total_servidores&#39;</span><span class="p">:</span> <span class="n">total_servidores</span><span class="p">,</span>
            <span class="s1">&#39;total_unidades&#39;</span><span class="p">:</span> <span class="n">total_unidades</span><span class="p">,</span>
            <span class="s1">&#39;total_cargos&#39;</span><span class="p">:</span> <span class="n">total_cargos</span><span class="p">,</span>
            <span class="s1">&#39;unidades_data&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">unidades_data</span><span class="p">),</span>
            <span class="s1">&#39;pontos_data&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">pontos_data</span><span class="p">),</span>
        <span class="p">})</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;erro_dados&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Erro ao carregar dados: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;core/relatorios.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="nd">@login_required</span>
<span class="nd">@require_http_methods</span><span class="p">([</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_relatorio_pontos_gratificacoes</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API para dados do relatório usando a API do organograma.</span>
<span class="sd">    Primeira tabela: Unidade, Pontos totais (sem GSIST/GSISP por enquanto)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpRequest</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Parâmetros de filtro</span>
        <span class="n">filtro_unidade</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unidade&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="c1"># Criar uma requisição interna para a API do organograma</span>
        <span class="n">internal_request</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span>
        <span class="n">internal_request</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;GET&#39;</span>
        <span class="n">internal_request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">internal_request</span><span class="o">.</span><span class="n">GET</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Chamar a API do organograma</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">api_organograma</span><span class="p">(</span><span class="n">internal_request</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="n">registros</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;core_unidadecargo&#39;</span><span class="p">,</span> <span class="p">[])</span>
            
            <span class="c1"># Processar dados do organograma</span>
            <span class="n">tabela_gratificacoes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">unidades_unicas</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="k">for</span> <span class="n">registro</span> <span class="ow">in</span> <span class="n">registros</span><span class="p">:</span>
                <span class="n">unidade</span> <span class="o">=</span> <span class="n">registro</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;denominacao_unidade&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">pontos</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">registro</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pontos_total&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                
                <span class="c1"># Aplicar filtro se fornecido</span>
                <span class="k">if</span> <span class="n">filtro_unidade</span> <span class="ow">and</span> <span class="n">filtro_unidade</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unidade</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">continue</span>
                
                <span class="k">if</span> <span class="n">unidade</span><span class="p">:</span>  <span class="c1"># Só incluir se tem nome da unidade</span>
                    <span class="k">if</span> <span class="n">unidade</span> <span class="ow">in</span> <span class="n">unidades_unicas</span><span class="p">:</span>
                        <span class="n">unidades_unicas</span><span class="p">[</span><span class="n">unidade</span><span class="p">][</span><span class="s1">&#39;pontos&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pontos</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">unidades_unicas</span><span class="p">[</span><span class="n">unidade</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;unidade&#39;</span><span class="p">:</span> <span class="n">unidade</span><span class="p">,</span>
                            <span class="s1">&#39;pontos&#39;</span><span class="p">:</span> <span class="n">pontos</span><span class="p">,</span>
                            <span class="s1">&#39;gsist&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Por enquanto zerado</span>
                            <span class="s1">&#39;gsisp&#39;</span><span class="p">:</span> <span class="mi">0</span>   <span class="c1"># Por enquanto zerado</span>
                        <span class="p">}</span>
            
            <span class="c1"># Converter para lista e ordenar</span>
            <span class="n">tabela_final</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unidades_unicas</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">tabela_final</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;unidade&#39;</span><span class="p">])</span>
            
            <span class="c1"># Arredondar pontos</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">tabela_final</span><span class="p">:</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;pontos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;pontos&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
                <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">tabela_final</span><span class="p">,</span>
                <span class="s1">&#39;filtros&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;unidade&#39;</span><span class="p">:</span> <span class="n">filtro_unidade</span><span class="p">,</span>
                    <span class="s1">&#39;total_registros&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">tabela_final</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Erro ao acessar dados do organograma&#39;</span>
            <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Erro ao carregar dados de gratificações: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>


<span class="nd">@login_required</span>
<span class="nd">@require_http_methods</span><span class="p">([</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_relatorio_dimensionamento</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API para dados do dimensionamento usando a API do organograma.</span>
<span class="sd">    Segunda tabela: Unidade, Pontos da área, Colaboradores (quantidade), IEE</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpRequest</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Parâmetros de filtro</span>
        <span class="n">filtro_unidade</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unidade&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="c1"># Criar uma requisição interna para a API do organograma</span>
        <span class="n">internal_request</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span>
        <span class="n">internal_request</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;GET&#39;</span>
        <span class="n">internal_request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">internal_request</span><span class="o">.</span><span class="n">GET</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Chamar a API do organograma</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">api_organograma</span><span class="p">(</span><span class="n">internal_request</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="n">registros</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;core_unidadecargo&#39;</span><span class="p">,</span> <span class="p">[])</span>
            
            <span class="c1"># Processar dados do organograma</span>
            <span class="n">tabela_dimensionamento</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">total_colaboradores_instituicao</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">total_pontos_instituicao</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="c1"># Agrupar por unidade</span>
            <span class="n">unidades_dados</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">registro</span> <span class="ow">in</span> <span class="n">registros</span><span class="p">:</span>
                <span class="n">unidade</span> <span class="o">=</span> <span class="n">registro</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;denominacao_unidade&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">pontos</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">registro</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pontos_total&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">quantidade</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">registro</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;quantidade&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                
                <span class="c1"># Aplicar filtro se fornecido</span>
                <span class="k">if</span> <span class="n">filtro_unidade</span> <span class="ow">and</span> <span class="n">filtro_unidade</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unidade</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">continue</span>
                
                <span class="k">if</span> <span class="n">unidade</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">unidade</span> <span class="ow">in</span> <span class="n">unidades_dados</span><span class="p">:</span>
                        <span class="n">unidades_dados</span><span class="p">[</span><span class="n">unidade</span><span class="p">][</span><span class="s1">&#39;pontos&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pontos</span>
                        <span class="n">unidades_dados</span><span class="p">[</span><span class="n">unidade</span><span class="p">][</span><span class="s1">&#39;colaboradores&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quantidade</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">unidades_dados</span><span class="p">[</span><span class="n">unidade</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;unidade&#39;</span><span class="p">:</span> <span class="n">unidade</span><span class="p">,</span>
                            <span class="s1">&#39;pontos&#39;</span><span class="p">:</span> <span class="n">pontos</span><span class="p">,</span>
                            <span class="s1">&#39;colaboradores&#39;</span><span class="p">:</span> <span class="n">quantidade</span><span class="p">,</span>
                            <span class="s1">&#39;consultoria&#39;</span><span class="p">:</span> <span class="mi">0</span>  <span class="c1"># Por enquanto zerado</span>
                        <span class="p">}</span>
            
            <span class="c1"># Calcular totais para IEE</span>
            <span class="k">for</span> <span class="n">dados</span> <span class="ow">in</span> <span class="n">unidades_dados</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">total_colaboradores_instituicao</span> <span class="o">+=</span> <span class="n">dados</span><span class="p">[</span><span class="s1">&#39;colaboradores&#39;</span><span class="p">]</span>
                <span class="n">total_pontos_instituicao</span> <span class="o">+=</span> <span class="n">dados</span><span class="p">[</span><span class="s1">&#39;pontos&#39;</span><span class="p">]</span>
            
            <span class="c1"># Calcular IEE: (Servidores na Unidade / Número de Pontos)</span>
            <span class="k">for</span> <span class="n">dados</span> <span class="ow">in</span> <span class="n">unidades_dados</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">colaboradores</span> <span class="o">=</span> <span class="n">dados</span><span class="p">[</span><span class="s1">&#39;colaboradores&#39;</span><span class="p">]</span>
                <span class="n">pontos</span> <span class="o">=</span> <span class="n">dados</span><span class="p">[</span><span class="s1">&#39;pontos&#39;</span><span class="p">]</span>
                
                <span class="c1"># IEE = Servidores na Unidade / Número de Pontos</span>
                <span class="n">iee</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">colaboradores</span> <span class="o">/</span> <span class="n">pontos</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="n">pontos</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                
                <span class="n">tabela_dimensionamento</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;unidade&#39;</span><span class="p">:</span> <span class="n">dados</span><span class="p">[</span><span class="s1">&#39;unidade&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;pontos&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">pontos</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="s1">&#39;colaboradores&#39;</span><span class="p">:</span> <span class="n">colaboradores</span><span class="p">,</span>
                    <span class="s1">&#39;consultoria&#39;</span><span class="p">:</span> <span class="n">dados</span><span class="p">[</span><span class="s1">&#39;consultoria&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;iee&#39;</span><span class="p">:</span> <span class="n">iee</span>
                <span class="p">})</span>
            
            <span class="c1"># Ordenar por nome da unidade</span>
            <span class="n">tabela_dimensionamento</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;unidade&#39;</span><span class="p">])</span>
            
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
                <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">tabela_dimensionamento</span><span class="p">,</span>
                <span class="s1">&#39;filtros&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;unidade&#39;</span><span class="p">:</span> <span class="n">filtro_unidade</span><span class="p">,</span>
                    <span class="s1">&#39;total_registros&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">tabela_dimensionamento</span><span class="p">)</span>
                <span class="p">},</span>
                <span class="s1">&#39;estatisticas&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;total_colaboradores_instituicao&#39;</span><span class="p">:</span> <span class="n">total_colaboradores_instituicao</span><span class="p">,</span>
                    <span class="s1">&#39;total_pontos_instituicao&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">total_pontos_instituicao</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="s1">&#39;formula_iee&#39;</span><span class="p">:</span> <span class="s1">&#39;IEE = (Servidores na Unidade / Número de Pontos)&#39;</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Erro ao acessar dados do organograma&#39;</span>
            <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Erro ao carregar dados de dimensionamento: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>


<span class="nd">@login_required</span>
<span class="nd">@require_http_methods</span><span class="p">([</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_historico_decretos</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API para histórico de decretos.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decreto</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">decretos_db</span> <span class="o">=</span> <span class="n">Decreto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-data_publicacao&#39;</span><span class="p">)</span>
        
        <span class="n">decretos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">decreto</span> <span class="ow">in</span> <span class="n">decretos_db</span><span class="p">:</span>
            <span class="n">decretos</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">decreto</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;numero&#39;</span><span class="p">:</span> <span class="n">decreto</span><span class="o">.</span><span class="n">numero</span><span class="p">,</span>
                <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">decreto</span><span class="o">.</span><span class="n">data_publicacao</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span>
                <span class="s1">&#39;titulo&#39;</span><span class="p">:</span> <span class="n">decreto</span><span class="o">.</span><span class="n">titulo</span><span class="p">,</span>
                <span class="s1">&#39;tipo&#39;</span><span class="p">:</span> <span class="n">decreto</span><span class="o">.</span><span class="n">get_tipo_display</span><span class="p">(),</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">decreto</span><span class="o">.</span><span class="n">get_status_display</span><span class="p">()</span>
            <span class="p">})</span>
        
        <span class="c1"># Se não há decretos no banco, usar dados simulados</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">decretos</span><span class="p">:</span>
            <span class="n">decretos</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;numero&#39;</span><span class="p">:</span> <span class="s1">&#39;Decreto nº 10.185/2019&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="s1">&#39;2019-12-20&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;titulo&#39;</span><span class="p">:</span> <span class="s1">&#39;Aprova a Estrutura Regimental e o Quadro Demonstrativo dos Cargos em Comissão e das Funções de Confiança do Ministério da Economia&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;tipo&#39;</span><span class="p">:</span> <span class="s1">&#39;Estrutura Regimental&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;Vigente&#39;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="s1">&#39;numero&#39;</span><span class="p">:</span> <span class="s1">&#39;Decreto nº 9.745/2019&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="s1">&#39;2019-04-08&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;titulo&#39;</span><span class="p">:</span> <span class="s1">&#39;Aprova a Estrutura Regimental e o Quadro Demonstrativo dos Cargos em Comissão e das Funções de Confiança do Ministério do Planejamento, Desenvolvimento e Gestão&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;tipo&#39;</span><span class="p">:</span> <span class="s1">&#39;Estrutura Regimental&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;Revogado&#39;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                    <span class="s1">&#39;numero&#39;</span><span class="p">:</span> <span class="s1">&#39;Decreto nº 11.355/2022&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="s1">&#39;2022-12-30&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;titulo&#39;</span><span class="p">:</span> <span class="s1">&#39;Aprova a Estrutura Regimental e o Quadro Demonstrativo dos Cargos em Comissão e das Funções de Confiança do Ministério do Planejamento e Orçamento&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;tipo&#39;</span><span class="p">:</span> <span class="s1">&#39;Estrutura Regimental&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;Vigente&#39;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
            <span class="s1">&#39;decretos&#39;</span><span class="p">:</span> <span class="n">decretos</span>
        <span class="p">})</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Erro ao carregar decretos: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>


<span class="nd">@login_required</span>
<span class="nd">@require_http_methods</span><span class="p">([</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_siglario</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API para o siglário institucional.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">UnidadeCargo</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Buscar todas as siglas únicas do organograma</span>
        <span class="n">siglas</span> <span class="o">=</span> <span class="n">UnidadeCargo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span>
            <span class="s1">&#39;sigla_unidade&#39;</span><span class="p">,</span> <span class="s1">&#39;denominacao_unidade&#39;</span><span class="p">,</span> <span class="s1">&#39;categoria_unidade&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
            <span class="n">sigla_unidade__isnull</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
            <span class="n">sigla_unidade__exact</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;sigla_unidade&#39;</span><span class="p">)</span>
        
        <span class="n">siglario_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">siglas</span><span class="p">:</span>
            <span class="n">siglario_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;sigla&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;sigla_unidade&#39;</span><span class="p">],</span>
                <span class="s1">&#39;denominacao&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;denominacao_unidade&#39;</span><span class="p">],</span>
                <span class="s1">&#39;categoria&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;categoria_unidade&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;Não categorizado&#39;</span>
            <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">siglario_data</span><span class="p">,</span>
            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">siglario_data</span><span class="p">)</span>
        <span class="p">})</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Erro ao carregar siglário: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>


<span class="nd">@login_required</span>
<span class="nd">@require_http_methods</span><span class="p">([</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_unidades_disponiveis</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API para buscar unidades disponíveis para formulários.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">UnidadeCargo</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">unidades</span> <span class="o">=</span> <span class="n">UnidadeCargo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span>
            <span class="s1">&#39;denominacao_unidade&#39;</span><span class="p">,</span> <span class="s1">&#39;sigla_unidade&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
            <span class="n">denominacao_unidade__isnull</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
            <span class="n">denominacao_unidade__exact</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;denominacao_unidade&#39;</span><span class="p">)</span>
        
        <span class="n">unidades_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">unidade</span> <span class="ow">in</span> <span class="n">unidades</span><span class="p">:</span>
            <span class="n">unidades_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;nome&#39;</span><span class="p">:</span> <span class="n">unidade</span><span class="p">[</span><span class="s1">&#39;denominacao_unidade&#39;</span><span class="p">],</span>
                <span class="s1">&#39;sigla&#39;</span><span class="p">:</span> <span class="n">unidade</span><span class="p">[</span><span class="s1">&#39;sigla_unidade&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
            <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
            <span class="s1">&#39;unidades&#39;</span><span class="p">:</span> <span class="n">unidades_data</span>
        <span class="p">})</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Erro ao carregar unidades: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>


<span class="nd">@login_required</span>
<span class="nd">@require_http_methods</span><span class="p">([</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">enviar_solicitacao_realocacao</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Processa o envio de solicitação de realocação.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">SolicitacaoRealocacao</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        
        <span class="c1"># Validar dados obrigatórios</span>
        <span class="n">campos_obrigatorios</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nome_servidor&#39;</span><span class="p">,</span> <span class="s1">&#39;matricula&#39;</span><span class="p">,</span> <span class="s1">&#39;unidade_atual&#39;</span><span class="p">,</span> <span class="s1">&#39;unidade_destino&#39;</span><span class="p">,</span> <span class="s1">&#39;justificativa&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">campo</span> <span class="ow">in</span> <span class="n">campos_obrigatorios</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">campo</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Campo obrigatório não preenchido: </span><span class="si">{</span><span class="n">campo</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
        
        <span class="c1"># Criar solicitação</span>
        <span class="n">solicitacao</span> <span class="o">=</span> <span class="n">SolicitacaoRealocacao</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">nome_servidor</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;nome_servidor&#39;</span><span class="p">],</span>
            <span class="n">matricula_siape</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;matricula&#39;</span><span class="p">],</span>
            <span class="n">unidade_atual</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;unidade_atual&#39;</span><span class="p">],</span>
            <span class="n">unidade_destino</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;unidade_destino&#39;</span><span class="p">],</span>
            <span class="n">justificativa</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;justificativa&#39;</span><span class="p">],</span>
            <span class="n">usuario_solicitante</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Solicitação de realocação enviada com sucesso!&#39;</span><span class="p">,</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">solicitacao</span><span class="o">.</span><span class="n">id</span>
        <span class="p">})</span>
        
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Dados inválidos&#39;</span>
        <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Erro ao processar solicitação: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>


<span class="nd">@login_required</span>
<span class="nd">@require_http_methods</span><span class="p">([</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">enviar_solicitacao_permuta</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Processa o envio de solicitação de permuta.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">SolicitacaoPermuta</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        
        <span class="c1"># Validar dados obrigatórios</span>
        <span class="n">campos_obrigatorios</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;servidor1&#39;</span><span class="p">,</span> <span class="s1">&#39;matricula1&#39;</span><span class="p">,</span> <span class="s1">&#39;servidor2&#39;</span><span class="p">,</span> <span class="s1">&#39;matricula2&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">campo</span> <span class="ow">in</span> <span class="n">campos_obrigatorios</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">campo</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Campo obrigatório não preenchido: </span><span class="si">{</span><span class="n">campo</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
        
        <span class="c1"># Buscar unidades dos servidores (simplificado - em produção seria mais complexo)</span>
        <span class="n">unidade1</span> <span class="o">=</span> <span class="s2">&quot;Unidade a definir&quot;</span>  <span class="c1"># Aqui seria feita uma busca real</span>
        <span class="n">unidade2</span> <span class="o">=</span> <span class="s2">&quot;Unidade a definir&quot;</span>  <span class="c1"># Aqui seria feita uma busca real</span>
        
        <span class="c1"># Criar solicitação</span>
        <span class="n">solicitacao</span> <span class="o">=</span> <span class="n">SolicitacaoPermuta</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">nome_servidor1</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;servidor1&#39;</span><span class="p">],</span>
            <span class="n">matricula_servidor1</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;matricula1&#39;</span><span class="p">],</span>
            <span class="n">unidade_servidor1</span><span class="o">=</span><span class="n">unidade1</span><span class="p">,</span>
            <span class="n">nome_servidor2</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;servidor2&#39;</span><span class="p">],</span>
            <span class="n">matricula_servidor2</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;matricula2&#39;</span><span class="p">],</span>
            <span class="n">unidade_servidor2</span><span class="o">=</span><span class="n">unidade2</span><span class="p">,</span>
            <span class="n">observacoes</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;observacoes&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="n">usuario_solicitante</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Solicitação de permuta enviada com sucesso!&#39;</span><span class="p">,</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">solicitacao</span><span class="o">.</span><span class="n">id</span>
        <span class="p">})</span>
        
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Dados inválidos&#39;</span>
        <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Erro ao processar solicitação: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>


<span class="nd">@login_required</span>
<span class="nd">@require_http_methods</span><span class="p">([</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_minhas_solicitacoes</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API para listar solicitações do usuário atual.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">SolicitacaoRealocacao</span><span class="p">,</span> <span class="n">SolicitacaoPermuta</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Buscar realocações</span>
        <span class="n">realocacoes</span> <span class="o">=</span> <span class="n">SolicitacaoRealocacao</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">usuario_solicitante</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-data_solicitacao&#39;</span><span class="p">)</span>
        
        <span class="c1"># Buscar permutas</span>
        <span class="n">permutas</span> <span class="o">=</span> <span class="n">SolicitacaoPermuta</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">usuario_solicitante</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-data_solicitacao&#39;</span><span class="p">)</span>
        
        <span class="n">realocacoes_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">realocacoes</span><span class="p">:</span>
            <span class="n">realocacoes_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;tipo&#39;</span><span class="p">:</span> <span class="s1">&#39;realocacao&#39;</span><span class="p">,</span>
                <span class="s1">&#39;servidor&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">nome_servidor</span><span class="p">,</span>
                <span class="s1">&#39;unidade_origem&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">unidade_atual</span><span class="p">,</span>
                <span class="s1">&#39;unidade_destino&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">unidade_destino</span><span class="p">,</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">get_status_display</span><span class="p">(),</span>
                <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">data_solicitacao</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">)</span>
            <span class="p">})</span>
        
        <span class="n">permutas_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">permutas</span><span class="p">:</span>
            <span class="n">permutas_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;tipo&#39;</span><span class="p">:</span> <span class="s1">&#39;permuta&#39;</span><span class="p">,</span>
                <span class="s1">&#39;servidor1&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">nome_servidor1</span><span class="p">,</span>
                <span class="s1">&#39;servidor2&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">nome_servidor2</span><span class="p">,</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get_status_display</span><span class="p">(),</span>
                <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">data_solicitacao</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y %H:%M&#39;</span><span class="p">)</span>
            <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
            <span class="s1">&#39;realocacoes&#39;</span><span class="p">:</span> <span class="n">realocacoes_data</span><span class="p">,</span>
            <span class="s1">&#39;permutas&#39;</span><span class="p">:</span> <span class="n">permutas_data</span>
        <span class="p">})</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Erro ao carregar solicitações: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</pre></div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
De Equipe Nexo
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025, Equipe Nexo.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>